<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>rsync 應用</h1><p class=mb-1>July 28, 2019</p><p>&mdash;</p></div><div class=content><h1 id=description>Description</h1><p>我是用 NAS 存放備份檔。方式有 2 種</p><ol><li>rsync 來建立鏡像資料夾。您需先用 CIFS 或 NFS 來將 Synology NAS 上的資料夾掛載至 Linux 伺服器。</li><li>Linux 執行指令，無需掛載資料夾。</li></ol><p>其中第 2 種方式是我實做出來的方式。</p><h2 id=rsync>rsync</h2><p>rsync 是一種異地備份軟體，與一般備份軟體不同的是，rsync 採用<code>增量備份</code>的方式，此類備份方式在每次備份前會先比較兩邊資料的差異，然後僅將差異的資料備份過去，而非備份全部的資料。</p><p>rsync 用於遠程複製和同步文件和目錄，以及在 Linux/Unix 系統中本地複製和同步。借助 rsync 命令，您可以跨目錄，跨硬碟和網路遠端和本地複製和同步數據，在兩台 Linux 計算機之間執行數據備份和鏡像。</p><p>rsync 的運作方式分為以下兩種：</p><ul><li><p>伺服器（Server）模式</p><ul><li>以常駐（Daemon）的方式運作，亦即以伺服器模式來服務（預設通訊埠為873），通常會在目的端運作，接收其他主機的備份資訊。</li></ul></li><li><p>客戶端（Client）模式</p><ul><li>以一般程式方式運作，可視為使用者端（Client）程式，通常用在來源端主機上，將資料備份到備份主機上運作。</li></ul></li></ul><h3 id=rsync-優點和功能>rsync 優點和功能</h3><ul><li>它有效的將文件複製到遠端系統或從遠端系統同步文件。</li><li>支持複製 links、devices、owners、groups 和 permissions。</li><li>它比 scp（Secure Copy）更快，因為 rsync 使用遠端更新協議，它允許僅傳輸兩組文件之間的差異。第一次，它將文件或目錄的全部內容從源複製到目標，但是從下次起，它僅將更改的塊和字節複製到目標。</li><li>Rsync 消耗較少的 <code>bandwidth</code>，因為它使用壓縮和解壓縮方法，同時發送和接收數據兩端。</li></ul><h3 id=rsynv-參數>rsynv 參數</h3><ul><li><p>-v</p><ul><li>verbose</li></ul></li><li><p>-z</p><ul><li>壓縮文件數據</li></ul></li><li><p>-h</p><ul><li>人類可讀的輸出數字，以人類可讀的格式</li></ul></li><li><p>-b</p><ul><li>表示要產生備份檔。當目的端上已存在同樣的檔案時，就將原先的檔案重新命名為其他的檔名，在此組態下，可利用 <code>--suffix</code> 子選項來命名備份檔案名稱的前綴檔名。另外，也可以指定 <code>--backup-dir</code> 子選項來設定備份檔的存放位置。</li></ul></li><li><p>-u</p><ul><li>在備份時會略過所有已經存在於目的端，且文件時間比要備份的檔案為新的檔案。</li></ul></li><li><p>-l</p><ul><li>要保留符號連結（Symbolic Link）型式的檔案。</li></ul></li><li><p>-p</p><ul><li>表示要保留檔案的權限資訊。</li></ul></li><li><p>-o</p><ul><li>要保留檔案擁有者資訊（僅對擁有者為root有效）。</li></ul></li><li><p>-g</p><ul><li>將保留檔案所屬群組資訊。</li></ul></li><li><p>-t</p><ul><li>表示要保留檔案時間資訊。</li></ul></li><li><p>-r</p><ul><li>表示以遞迴的方式來備份資料，包括所要備份目錄下的所有子目錄。</li></ul></li><li><p>-a</p><ul><li>等同於設定 -rlptgoD 等組態。</li></ul></li><li><p>-D</p><ul><li>表示要保留設備檔案資訊（僅對擁有者為root有效）。</li></ul></li><li><p>--progress</p><ul><li>顯示進度</li></ul></li><li><p>--delete</p><ul><li>刪除來源端已經不存在但在目的端存在的檔案。</li></ul></li><li><p>--force</p><ul><li>當目的端的目錄被覆蓋時，就強制先刪除該目錄。</li></ul></li><li><p>--bwlimit</p><ul><li>限制 I/O bindwitdh</li></ul></li><li><p>--daemon</p><ul><li>表示 rsync 將以常駐程式的型式來執行，亦即以伺服器的型式來執行。</li></ul></li><li><p>--remove-source-files</p><ul><li>成功傳輸後，將來源檔案刪除</li></ul></li></ul><h3 id=rsync-啟用>rsync 啟用</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo vi /etc/default/rsync
RSYNC_ENABLE<span style=color:#f92672>=</span>true <span style=color:#75715e>#預設 false</span>
</code></pre></div><h2 id=實作>實作</h2><h3 id=ubuntu-to-ubuntu>ubuntu to ubuntu</h3><ul><li>ubuntu<ul><li>192.168.222.128</li><li>client</li></ul></li><li>ubuntu<ul><li>192.168.222.132</li><li>server（client 備份資料儲存地方）</li></ul></li></ul><p>預設上無須配置 rsync 設定檔即可傳輸（範例1、2）</p><ol><li>複製目錄/檔案，從 128 傳至 132（IP）</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ rsync -zvh test.csv.zip lab702@192.168.222.132:/tmp
The authenticity of host <span style=color:#e6db74>&#39;192.168.222.132 (192.168.222.132)&#39;</span> can<span style=color:#e6db74>&#39;t be established.
</span><span style=color:#e6db74>ECDSA key fingerprint is SHA256:TmidBei2XVw7f2lqHuSrjfFHsFRz6riglpwY/tKXlXc.
</span><span style=color:#e6db74>Are you sure you want to continue connecting (yes/no)? yes
</span><span style=color:#e6db74>Warning: Permanently added &#39;</span>192.168.222.132<span style=color:#e6db74>&#39; (ECDSA) to the list of known hosts.
</span><span style=color:#e6db74>lab702@192.168.222.132&#39;</span>s password:
skipping directory .
test.csv.zip

sent 675.07M bytes  received <span style=color:#ae81ff>35</span> bytes  8.49M bytes/sec
total size is 674.68M  speedup is 1.00
</code></pre></div><ol start=2><li>複製目錄/檔案，從 132 傳至 128（IP）</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>lab702@elk:~$ ls /tmp/
dupl-usagereport-4684-20190214012833.json  HttpServer  systemd-private-fdf1de5804eb4744968fea5bf13e6734-systemd-timesyncd.service-6nds2r  vmware-root
lab702@elk:~$ rsync -azvh lab702@192.168.222.132:/tmp/test.csv.zip /tmp
lab702@192.168.222.132<span style=color:#960050;background-color:#1e0010>&#39;</span>s password:
receiving incremental file list
test.csv.zip

sent <span style=color:#ae81ff>43</span> bytes  received 675.07M bytes  16.67M bytes/sec
total size is 674.68M  speedup is 1.00
lab702@elk:~$ ls /tmp/
dupl-usagereport-4684-20190214012833.json  HttpServer  systemd-private-fdf1de5804eb4744968fea5bf13e6734-systemd-timesyncd.service-6nds2r  test.csv.zip  vmware-root
</code></pre></div><ol start=3><li>無密碼
因為上述的做法需要輸入 server 端的密碼。以下是透過配置檔來達到認證不用輸入密碼，而進行傳輸。</li></ol><h6 id=server-設置>Server 設置</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#f92672>[</span>rsync_test<span style=color:#f92672>]</span>
path <span style=color:#f92672>=</span> /tmp <span style=color:#75715e># 存放備份資料的目錄</span>
auth users <span style=color:#f92672>=</span>  lab702 <span style=color:#75715e># 認證帳號</span>
uid <span style=color:#f92672>=</span> root <span style=color:#75715e># 用來啟動 rsync server 的 uid</span>
gid <span style=color:#f92672>=</span> root <span style=color:#75715e># 用來啟動 rsync server 的 gid</span>
read only <span style=color:#f92672>=</span> false <span style=color:#75715e># 是否設定為唯讀 </span>
write_only <span style=color:#f92672>=</span> false <span style=color:#75715e># 是否設定為可寫</span>
log file <span style=color:#f92672>=</span> /var/log/rsync.log
hosts allow <span style=color:#f92672>=</span> 192.168.222.0/24 <span style=color:#75715e># 允許使用 rsync連入的ip</span>
<span style=color:#75715e>#hosts deny = * # 不允許連入的 ip，* 表示全拒絕</span>
secrets file <span style=color:#f92672>=</span> /etc/rsyncd.secrets <span style=color:#75715e># 認證檔存放路徑</span>
dont compress <span style=color:#f92672>=</span> *.gz *.tgz *.zip *.z *.rpm *.deb *.iso *.bz2 *.tbz <span style=color:#75715e># 不對這些副檔名的檔案做壓縮</span>
</code></pre></div><p>設定認證，Serve 認證 Client</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo vi /etc/rsyncd.secrets
account:password <span style=color:#75715e># 帳號:密碼</span>
</code></pre></div><p>權限設定，認證檔案的權限設為 <code>600</code>，並將擁有者設為 <code>root</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo chmod <span style=color:#ae81ff>600</span> /etc/rsyncd.secrets 
$ sudo chown root:root /etc/rsyncd.secrets
</code></pre></div><p>client 設定來源端的密碼認證檔，權限也如上</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo vi /etc/rsyncd.pwd <span style=color:#75715e># server 所設定的密碼</span>
</code></pre></div><p>完成後，傳輸資料時則不必輸入 Server 端密碼</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo rsync -avzrpog --password-file<span style=color:#f92672>=</span>/etc/rsyncd.pwd a.txt lab702@192.168.222.132::rsync_test
</code></pre></div><h3 id=ubuntu-rsync-to-nas>ubuntu rsync to NAS</h3><ul><li>ubuntu 12</li><li>NAS</li></ul><p>這部分是我因為有管理學校的小系統，這系統都有做定期備份，但學長們都是用將資料拉到 USB 做備份，因此我接手的時候想到用 rsync 備份至 NAS，這樣減少了定期拿 USB 手動拿資料的時間。
NAS 需要設定，但 NAS 部分我不是負責人。這裡就不描述。</p><h5 id=將-ubuntu-要備份資料遠端至-nas-上>將 ubuntu 要備份資料遠端至 NAS 上</h5><ol><li></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>rsync -av  --progress --remove-source-files  /home/misc/backup/NFS <span style=color:#f92672>[</span>NASAccount<span style=color:#f92672>]</span>@<span style=color:#f92672>[</span>NAS-Domain<span style=color:#f92672>]</span>::<span style=color:#f92672>[</span>資料夾名稱<span style=color:#f92672>]</span>
</code></pre></div><ol start=2><li></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo vi /etc/rsyncd.pwd
$ sudo chmod <span style=color:#ae81ff>600</span> /etc/rsyncd.pw
$ sudo chown root:root /etc/rsyncd.pwd
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo rsync -av  --progress --remove-source-files --password-file<span style=color:#f92672>=</span>/etc/rsyncd.pwd   a.txt  <span style=color:#f92672>[</span>NASAccount<span style=color:#f92672>]</span>@<span style=color:#f92672>[</span>NAS-Domain<span style=color:#f92672>]</span>::<span style=color:#f92672>[</span>資料夾名稱<span style=color:#f92672>]</span>
</code></pre></div><p><img src=https://i.imgur.com/Q8oMqoN.png alt></p><h2 id=錯誤解決>錯誤解決</h2><h5 id=服務端設置-read-only--false>服務端設置 read only = false</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ rsync -av  --progress --remove-source-files  test.csv.zip  <span style=color:#f92672>[</span>NASAccount<span style=color:#f92672>]</span>@<span style=color:#f92672>[</span>NAS-Domain<span style=color:#f92672>]</span>::<span style=color:#f92672>[</span>資料夾名稱<span style=color:#f92672>]</span>
Password:
sending incremental file list
test.csv.zip
         32,768   0%    0.00kB/s    0:00:00
rsync: read error: Connection reset by peer <span style=color:#f92672>(</span>104<span style=color:#f92672>)</span>
rsync error: error in socket IO <span style=color:#f92672>(</span>code 10<span style=color:#f92672>)</span> at io.c<span style=color:#f92672>(</span>785<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>=</span>3.1.1<span style=color:#f92672>]</span>
</code></pre></div><h5 id=調整-nas-給予的檔案大小限制>調整 NAS 給予的檔案大小限制</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>rsync: writefd_unbuffered failed to write <span style=color:#ae81ff>4</span> bytes to socket <span style=color:#f92672>[</span>sender<span style=color:#f92672>]</span>: Connection reset by peer <span style=color:#f92672>(</span>104<span style=color:#f92672>)</span>
rsync: connection unexpectedly closed <span style=color:#f92672>(</span><span style=color:#ae81ff>28</span> bytes received so far<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>]</span>
rsync error: error in rsync protocol data stream <span style=color:#f92672>(</span>code 12<span style=color:#f92672>)</span> at io.c<span style=color:#f92672>(</span>605<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>=</span>3.0.9<span style=color:#f92672>]</span>
</code></pre></div><h5 id=硬碟磁區受損>硬碟磁區受損</h5><p>調整一下 NAS</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo rsync -av  --progress --remove-source-files /home/misc/backup/NFS <span style=color:#f92672>[</span>NASAccount<span style=color:#f92672>]</span>@<span style=color:#f92672>[</span>NAS-Domain<span style=color:#f92672>]</span>::<span style=color:#f92672>[</span>資料夾名稱<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> itachi:
Password:
sending incremental file list
NFS/jihmsp/
NFS/jihmsp/2018-10-20-05-00-02_jihmsp.tar.gz
  <span style=color:#ae81ff>1330249728</span>  78%   11.16MB/s    0:00:32
rsync: writefd_unbuffered failed to write <span style=color:#ae81ff>4</span> bytes to socket <span style=color:#f92672>[</span>sender<span style=color:#f92672>]</span>: Connection reset by peer <span style=color:#f92672>(</span>104<span style=color:#f92672>)</span>
rsync: write failed on <span style=color:#e6db74>&#34;NFS/jihmsp/2018-10-20-05-00-02_jihmsp.tar.gz&#34;</span> <span style=color:#f92672>(</span>in AICT_BIT_Backup<span style=color:#f92672>)</span>: Disk quota exceeded <span style=color:#f92672>(</span>122<span style=color:#f92672>)</span>
rsync error: Quota exceeded <span style=color:#f92672>(</span>code 54<span style=color:#f92672>)</span> at receiver.c<span style=color:#f92672>(</span>358<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>receiver<span style=color:#f92672>=</span>3.0.9<span style=color:#f92672>]</span>
rsync: connection unexpectedly closed <span style=color:#f92672>(</span><span style=color:#ae81ff>399</span> bytes received so far<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>]</span>
rsync error: error in rsync protocol data stream <span style=color:#f92672>(</span>code 12<span style=color:#f92672>)</span> at io.c<span style=color:#f92672>(</span>605<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>=</span>3.0.9<span style=color:#f92672>]</span>
</code></pre></div><p><img src=https://i.imgur.com/uL9WOyI.png alt></p><h5 id=權限-600-和-giduid-問題>權限 600 和 gid、uid 問題</h5><p>權限 600，uid、gid 都是 root，這部分要看 Server 配置檔的設定</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ERROR: password file must not be other-accessible
rsync error: syntax or usage error <span style=color:#f92672>(</span>code 1<span style=color:#f92672>)</span> at authenticate.c<span style=color:#f92672>(</span>175<span style=color:#f92672>)</span> <span style=color:#f92672>[</span>sender<span style=color:#f92672>=</span>3.0.9<span style=color:#f92672>]</span>
</code></pre></div><h2 id=參考資料>參考資料</h2><p><a href=https://www.synology.com/zh-tw/knowledgebase/DSM/tutorial/Backup_Restore/How_to_back_up_Linux_computer_to_Synology_NAS>How_to_back_up_Linux_computer_to_Synology_NAS</a></p><p><a href=https://blog.gtwang.org/linux/rsync-local-remote-file-synchronization-commands/>rsync commands</a></p><p><a href="https://www.netadmin.com.tw/article_content.aspx?sn=1810010005&jump=4">網管人</a></p><p><a href=http://wiki.weithenn.org/cgi-bin/wiki.pl?Rsync-%E8%B3%87%E6%96%99%E5%90%8C%E6%AD%A5%E5%8F%8A%E7%95%B0%E5%9C%B0%E5%82%99%E4%BB%BD>weithenn</a></p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/project/2019-07-03-namespace/ title="Net Namespaces"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/project/2019-11-15-elk-input-csv/ title="input csv to elasticsearch"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
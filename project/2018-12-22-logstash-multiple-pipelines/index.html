<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>logstash Multiple Pipelines</h1><p class=mb-1>December 22, 2018</p><p>&mdash;</p></div><div class=content><h1 id=logstash-multiple-pipelines>logstash Multiple Pipelines</h1><p>遇到的問題是，使用 <code>filebeat</code> 將 json 數據傳遞給 <code>logstash</code> 處裡並建立索引 pcap 與使用 logstash 讀取 CSV 數據建立 CSV 索引。
兩者都是不同的索引。但是 <code>kibana</code> 上的 pcap 索引卻讀取 csv 索引數據。這造成分析上的錯誤。以下會先了解 <code>logstash</code> 運作以及解決方式。</p><p>Logstash 事件處理管道有三個階段：inputs → filters → outputs。</p><ul><li>inputs<ul><li>生成事件</li></ul></li><li>filters<ul><li>修改它們，輸出將它們發送到其他地方</li></ul></li></ul><p>輸入和輸出支援編解碼，能夠在數據進入或退出管道時對數據進行編碼或解碼，而無需使用單獨的 filters。</p><h2 id=inputs>inputs</h2><p>將輸入的數據導入至 logstash。
常用的輸入：</p><ul><li>file<ul><li>從文件系統上的文件讀取，與UNIX命令非常相似 tail -0F</li></ul></li><li>syslog<ul><li>在已知端口514上偵聽syslog消息並根據RFC3164格式進行解析</li></ul></li><li>redis<ul><li>使用 redis 通道和 redis 列表從 redis 服務器讀取。</li><li>Redis 通常用作集中式 Logstash 安裝中的"broker"，該安裝將 Logstash 事件從遠程 Logstash &ldquo;shippers&rdquo; 排隊。</li></ul></li><li>beats<ul><li>處理 Beats發送的事件</li></ul></li></ul><p><a href=https://www.elastic.co/guide/en/logstash/current/input-plugins.html>plugins</a></p><h2 id=filters>Filters</h2><p>是 Logstash 管道中的中間處理機制。可以將過濾與條件組合，以便在事件滿足特定條件時對其執行操作。
常用的過濾：</p><ul><li>grok<ul><li>解析並構造任意數據</li><li>目前 Logstash 中將<strong>非結構化</strong> log 數據解析為結構化和可查詢內容的最佳方式</li><li>Logstash 內置了 120 種模式</li></ul></li><li>mutate<ul><li>對事件字段執行常規轉換</li><li>可以重命名、刪除、替換和修改事件中的字段</li></ul></li><li>drop<ul><li>完全刪除事件，例如 <em>debug</em> 事件</li></ul></li><li>clone<ul><li>製作事件的副本，可能添加或刪除字段</li></ul></li><li>geoip<ul><li>添加有關 IP 地址的地理位置的信息</li></ul></li></ul><p><a href=https://www.elastic.co/guide/en/logstash/current/filter-plugins.html>plugins</a></p><h2 id=outputs>Outputs</h2><p>輸出是 Logstash 管道的最後階段。事件可以傳遞多個輸出，但是一旦所有輸出處理完成，事件就完成了它的執行。
常用的輸出：</p><ul><li>elasticsearch<ul><li>將事件數據發送給 Elasticsearch。</li><li>計劃以高效、方便且易於查詢的格式保存數據&mldr;&mldr; Elasticsearch 是最佳選擇。</li></ul></li><li>file<ul><li>將事件數據寫入 Disk 上的 file。</li></ul></li><li><a href=http://graphite.readthedocs.io/en/latest/>graphite</a><ul><li>將事件數據發送到 graphite，這是一種用於存儲和繪製指標的流行開源工具。</li></ul></li><li>statsd<ul><li>將事件數據發送到 statsd，這是一種"偵聽統計信息，如計數器和定時器，通過 UDP 發送並將聚合發送到一個或多個可插入後端服務"的服務。</li></ul></li></ul><h2 id=codecs>Codecs</h2><p>編解碼器基本上是串流過濾器，可以作為輸入或輸出的一部分運行。使用編解碼器可以輕鬆地將消息傳輸與序列化過程分開。流行的編解碼器包括 json、msgpack 和 plain。</p><ul><li>json<ul><li>以 JSON 格式編碼或解碼數據</li></ul></li><li>multiline<ul><li>將多行文字事件（例如 java 異常和 stacktrace 消息）合併到一個事件中。</li></ul></li></ul><p><a href=https://www.elastic.co/guide/en/logstash/current/codec-plugins.html>plugins</a></p><h2 id=問題解決>問題解決</h2><p>藉由 Multiple Pipelines 來實現。這裡需再 logstahs 的 config 目錄裡新增 <code>pipelines.yml</code> 檔案，
這邊在 docker-compose 已經做一個掛載的動作，不須再而外掛載。</p><h3 id=pipelinesyml>pipelines.yml</h3><p>透過 <code>pipelines.yml</code> 的配置文件中讀取它們的定義。
其中 <code>logstash.yml</code> 中的 <code>path.config: /usr/share/logstash/pipeline</code> 必須註解，未在 <code>pipelines.yml</code> 檔案中寫入設置的值將回參考 <code>logstash.yml</code> 設置檔案中指定的默認值。</p><pre><code class="language-shell=" data-lang="shell=">logstash$ vi config/pipelines.yml
- pipeline.id: csv
  queue.type: persisted
  path.config: &quot;/usr/share/logstash/pipeline/readCSV.conf&quot;
- pipeline.id: pcap
  queue.type: persisted
  path.config: &quot;/usr/share/logstash/pipeline/pcap.conf&quot;
- pipeline.id: metricbeat
  queue.type: persisted
  path.config: &quot;/usr/share/logstash/pipeline/metricbeat.conf&quot;

</code></pre><h2 id=參考資料>參考資料</h2><p><a href=https://www.elastic.co/blog/logstash-multiple-pipelines>logstash-multiple-pipelines</a>
<a href=https://discuss.elastic.co/t/different-files-are-entered-into-logstash-kibana-fields-show-the-same/161243/8>discuss</a></p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/project/2018-07-14-nas-esxi/ title="NAS 與 ESXi"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/project/2018-12-24-apc-ups/ title="ups 應用"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
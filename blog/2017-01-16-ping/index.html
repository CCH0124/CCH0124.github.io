<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>ping 指令</h1><p class=mb-1>January 16, 2017</p><p>&mdash;</p></div><div class=content><h1 id=ping>ping</h1><p>是網路上常見的診斷工具。</p><ul><li>用來判斷網路是否可連線</li><li>是否有設備連接</li></ul><p><code>ping</code> 是網路中必要的工具。</p><p>以下會介紹 ping 的使用以及 ICMP 協定。</p><h2 id=ping-work>ping work</h2><p>發送 <code>ICMP(Internet Control Message Protocol)</code> 封包至目的端，最後的訊息可以判斷網路狀態的優良。
<code>ICMP</code> 主要用於確定數據是否及時到達預定目的地。當兩個設備透過 Internet 連線時，如果任何數據未到達其預期目的地，則 ICMP 會生成錯誤回傳。常用的終端應用程式 <code>traceroute</code> 和 <code>ping</code> 都使用 <code>ICMP</code> 進行操作。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ping <span style=color:#f92672>[</span>options<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>destination<span style=color:#f92672>]</span>
</code></pre></div><p>ping options</p><ul><li>-c<ul><li>指定要發送的 packet 數量</li></ul></li><li>-s<ul><li>更改 packet 的大小</li></ul></li><li>-v<ul><li>詳細訊息</li></ul></li><li>-w<ul><li>指定命令執行結束的時間（以秒為單位）無論命令發送或接收的 packet 數量</li></ul></li><li>-i<ul><li>可以指定要使用的網路介面</li></ul></li></ul><p>ping destination</p><ul><li>目的地 IP address</li><li>hostname</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ping -w <span style=color:#ae81ff>3</span> -c <span style=color:#ae81ff>10</span> www.google.com
PING www.google.com <span style=color:#f92672>(</span>172.217.27.132<span style=color:#f92672>)</span> 56<span style=color:#f92672>(</span>84<span style=color:#f92672>)</span> bytes of data.
<span style=color:#ae81ff>64</span> bytes from tsa03s02-in-f4.1e100.net <span style=color:#f92672>(</span>172.217.27.132<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span> time<span style=color:#f92672>=</span>41.4 ms
<span style=color:#ae81ff>64</span> bytes from tsa03s02-in-f4.1e100.net <span style=color:#f92672>(</span>172.217.27.132<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span> time<span style=color:#f92672>=</span>53.1 ms
<span style=color:#ae81ff>64</span> bytes from tsa03s02-in-f4.1e100.net <span style=color:#f92672>(</span>172.217.27.132<span style=color:#f92672>)</span>: icmp_seq<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>128</span> time<span style=color:#f92672>=</span>86.5 ms

--- www.google.com ping statistics ---
<span style=color:#ae81ff>3</span> packets transmitted, <span style=color:#ae81ff>3</span> received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev <span style=color:#f92672>=</span> 41.411/60.373/86.571/19.135 ms
</code></pre></div><blockquote><p>ping6 為 IPv6 的使用方式</p></blockquote><p>ping 無法提供 port 的方式來檢測網路，但可以用 <code>telnet</code> 去實現。</p><h2 id=ping-all-hosts-on-the-subnet>Ping all hosts on the subnet</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ ping -b -c <span style=color:#ae81ff>4</span> 192.168.1.255 <span style=color:#75715e># 加上 -b 參數，目的用廣播位置</span>
</code></pre></div><p>如果 <code>destination is unreachable</code>，可能阻止了 ping 發送的 ICMP packet，或者路由表上可能存在網路問題或路由問題</p><h2 id=find-the-best-mtu>Find the best MTU</h2><p>MTU（Maximum transmission unit）是表示可以透過網路發送的最大 packet 的 byte 大小的值。大多數乙太網區域網路使用 1500 byte MTU。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell> ping -M <span style=color:#66d9ef>do</span> -s <span style=color:#ae81ff>1501</span> 192.168.137.2
PING 192.168.137.2 <span style=color:#f92672>(</span>192.168.137.2<span style=color:#f92672>)</span> 1501<span style=color:#f92672>(</span>1529<span style=color:#f92672>)</span> bytes of data.
ping: local error: Message too long, mtu<span style=color:#f92672>=</span><span style=color:#ae81ff>1500</span>
ping: local error: Message too long, mtu<span style=color:#f92672>=</span><span style=color:#ae81ff>1500</span>
ping: local error: Message too long, mtu<span style=color:#f92672>=</span><span style=color:#ae81ff>1500</span>
^C
--- 192.168.137.2 ping statistics ---
<span style=color:#ae81ff>3</span> packets transmitted, <span style=color:#ae81ff>0</span> received, +3 errors, 100% packet loss, time 2016ms
</code></pre></div><h2 id=ping-on-layer-2->Ping on layer 2 ?</h2><p>使用 <code>arping</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ arpin <span style=color:#f92672>[</span>IP<span style=color:#f92672>]</span>
</code></pre></div><h2 id=traceroute>traceroute</h2><p><code>ping</code> 不顯示從來源到達目地的路由。如果與主機的連接不通，這非常有用，因為可以理解連接不通的位置。tracert 或 traceroute 命令的工作方式與 ping 相似。好處是它說明了 packet 所採用的路徑(hop)，從而顯示了其路由。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>traceroute <span style=color:#f92672>[</span>hostname/IP<span style=color:#f92672>]</span>
</code></pre></div><h2 id=disable-ping>disable ping</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo echo <span style=color:#e6db74>&#34;1&#34;</span> &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all
</code></pre></div><p>永久執行此設定</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo vi /etc/sysctl.conf
net.ipv4.icmp_echo_ignore_all<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
$ sudo sysctl -p
</code></pre></div><h2 id=icmp>ICMP</h2><p>ICMP（Internet Control Message Protocol），可用來確認網路是否正常運作。網路七層協定中的第三層。</p><p>訊息類型</p><table><thead><tr><th>類型</th><th>內容</th></tr></thead><tbody><tr><td>0</td><td>Echo Reply（回應訊息）</td></tr><tr><td>3</td><td>Destination Unreachable（無法送達）</td></tr><tr><td>4</td><td>Source Quench（來源抑制）</td></tr><tr><td>5</td><td>Redirect（重新導向）</td></tr><tr><td>8</td><td>Echo Request（請求訊息）</td></tr><tr><td>9</td><td>Router Advertisement（路由器公告）</td></tr><tr><td>10</td><td>Router Solicitation（路由器請求）</td></tr><tr><td>11</td><td>Time Exceeded（超時）</td></tr><tr><td>17</td><td>Address Mask Request（位址遮罩請求）</td></tr><tr><td>18</td><td>Address Mask Reply（位址遮罩回應）</td></tr></tbody></table><p>常見類型
類型 3：
Router 無法將封包送達到目的地，會對傳送端主機回應此訊息。相對的代碼最多出現的是，0 和 1。0 表示沒該 IP 的路由資訊；1 表示該 Host 沒有連接網路。4 是用於 Path MTU Discovery，讓傳送端 Host 知道原因，使得資料無法到達目的地。</p><table><thead><tr><th>代碼</th><th>ICMP 無法送達訊息</th></tr></thead><tbody><tr><td>0</td><td>Network Unreachable</td></tr><tr><td>1</td><td>Host Unreachable</td></tr><tr><td>2</td><td>Protocol Unreachable</td></tr><tr><td>3</td><td>Port Unreachable</td></tr><tr><td>4</td><td>Fragmentation Needed and Don’t Fragment was Set</td></tr><tr><td>5</td><td>Source Route Failed</td></tr><tr><td>6</td><td>Destination Network Unknown</td></tr><tr><td>7</td><td>Destination Host Unknown</td></tr><tr><td>8</td><td>Source Host Isolated</td></tr><tr><td>9</td><td>Communication with Destination Network is Administratively Prohibited</td></tr><tr><td>10</td><td>Communication with Destination Host is Administratively Prohibited</td></tr><tr><td>11</td><td>Destination Network Unreachable for type of Service</td></tr><tr><td>12</td><td>Destination Host Unreachable for type of Service</td></tr></tbody></table><p>類型5：
當 Router 擁有更好的 Routing table，會採取此類型的訊息。</p><table><thead><tr><th>代碼</th><th>ICMP Type5 訊息</th></tr></thead><tbody><tr><td>0</td><td>Redirect for Network</td></tr><tr><td>1</td><td>Redirect for Host</td></tr><tr><td>2</td><td>Redirect for Type of Service and Network</td></tr><tr><td>3</td><td>Redirect for Type of Service and Host</td></tr></tbody></table><p>類型11：
在 IP 封包中，有個 TTL 欄位。此值經過一個 Router 及遞減 1，當它為 0 時則丟棄此 IP 封包。此時 Router 回傳此類型資訊的錯誤代碼 0 給傳送端的 Host。
會設置此 TTL 是為了避免路由迴圈。當迴圈形成時，封包就無限轉發導致網路癱瘓。如果限制封包傳送的節點可設定 TTL。</p><table><thead><tr><th>代碼</th><th>ICMP Type11訊息</th></tr></thead><tbody><tr><td>0</td><td>Time-to-live exceeded in transit</td></tr><tr><td>1</td><td>Fragment reassembly time exceeded</td></tr></tbody></table><p>類型 0、8：
想要確認彼此是否能通訊。會使用此兩種訊息，8向對方Host請求訊息；0 對方回應訊息。當向對方請求，對方也回應代表彼此，是可以通訊的。</p><p>Ping 是以這種方式回應。</p><h2 id=ping-network-attack>Ping network attack</h2><p>無限發送 ping 封包達到讓對方網路設備無法提供服務的攻擊。使對方網路設備做某些沒有意義的事情，無法提供原本該提供的服務，又稱「DOS」。</p><h2 id=icmp-header-format>ICMP Header Format</h2><p><img src=https://i.imgur.com/matiwMs.png alt title=wiki></p><ul><li>Type<ul><li>1Byte 上述訊息類型</li></ul></li><li>Code<ul><li>1Byte 上述代碼</li></ul></li><li>Checksum<ul><li>2Byte 錯誤檢查</li></ul></li><li>Rest of Header<ul><li>4Byte，內容因 Type 和 Coed，而有不同</li></ul></li></ul><h2 id=wireshark>Wireshark</h2><p><img src=https://i.imgur.com/zNB53pi.png alt title="ICMP 抓包"></p><p><img src=https://i.imgur.com/lcZQ3BD.png alt title="ICMP Request"></p><p><img src=https://i.imgur.com/ikIeODJ.png alt title="ICMP Reply"></p><p><img src=https://i.imgur.com/vexXIIe.png alt title=traceroute> 可以驗證說他是走 ICMP。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/blog/2016-10-02-arp/ title="ARP Protocol"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/blog/2017-02-11-file-dir-management/ title=系統找尋檔案><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Static NAT</h1><p class=mb-1>January 1, 0001</p><p>&mdash;</p></div><div class=content><h2 id=環境>環境</h2><figure><img src=/images/GNS3/static-NAT.png width=auto height=auto></figure><p>配置一台 <code>host only</code> 的虛擬機和一台 R1 路由器以及可以連至網際網路的 Cloud1。該 <code>Cloud1</code> 使用的是手機 <code>USB</code> 出來的網路適配器。</p><h2 id=配置-r1>配置 R1</h2><p>配置 f0/0 的 IP，對於這個 f0/0 來說它是虛擬機的 <code>gateway</code>，只要封包不知道要往哪邊走都會網 f0/0 丟。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#interface fastEthernet 0/0</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#ip address 192.168.245.254 255.255.255.0</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#no shutdown</span>
</code></pre></div><p>配置 R1 的 Outside 接口，使用 DHCP 方式向 Cloud1 請求 IP。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#interface fastEthernet 1/0</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#no shutdown</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#ip address dhcp</span>
</code></pre></div><p>確認有無配置到 IP。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#do sh ip int brief</span>
Interface                  IP-Address      OK? Method Status                Protocol
FastEthernet0/0            192.168.245.254 YES manual up                    up
FastEthernet1/0            192.168.42.186  YES DHCP   up                    up
</code></pre></div><p>接著虛擬機嘗試 ping <code>gateway</code> 就是 f0/0 接口，要成功否則須檢查網路配置。再 ping f1/0 接口也是要通的，雖然不同網段但是是<em>直連</em>網路。如果 <code>ping 8.8.8.8</code> 是無法連接的，因為對虛擬機來說她不知道要把 8.8.8.8 這個的封包轉發到哪，因此它會丟向 R1 的 f0/0 接口，但 f0/0 接口也不知到要怎麼轉發所以導致無法成功的通訊，這邊就需配置 NAT。</p><p>同樣的先設置好，<code>Inside</code> 和 <code>Outside</code> 的接口，接著使用 <code>ip nat</code> 方式建立一個 <code>static</code> 的 NAT 對應表。<code>ip nat inside source</code> 指的是要使用<code>Inside</code> 內的主機 IP，<code>static</code> 表示建立靜態的 NAT，最後輸入 <code>Inside</code> 的 IP 和要對應的 <code>Outside</code> IP，這種方式和設定靜態路由很像，這邊的設定已經是指名去轉換，因此就不必要像動態 NAT 一樣去做一個 <code>access-list</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#int fastEthernet 0/0</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#ip nat inside</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#int fastEthernet 1/0</span>
R1<span style=color:#f92672>(</span>config-if<span style=color:#f92672>)</span><span style=color:#75715e>#ip nat outside</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip nat inside source static 192.168.245.8 192.168.42.190 </span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip name-server 192.168.42.1</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip domain-lookup</span>
</code></pre></div><p>我們在 R1 添加了一個靜態 NAT 後在虛擬機嘗試 ping 8.8.8.8，這次因為透過 NAT 轉換而請求成功，如下圖</p><p><img src=https://i.imgur.com/IfIWUEw.png alt></p><h3 id=驗證>驗證</h3><p>查看 NAT 過程，這部分在動態的 NAT 說明過。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1#show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
tcp 192.168.42.190:34100 192.168.245.8:34100 204.79.197.200:80 204.79.197.200:80
tcp 192.168.42.190:52330 192.168.245.8:52330 8.8.8.8:80      8.8.8.8:80
--- 192.168.42.190     192.168.245.8      ---                ---
</code></pre></div></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><i class="nav-menu-disabled fas fa-chevron-circle-left"></i></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/blog/2018-08-03-port-scanner/ title="port scanner"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
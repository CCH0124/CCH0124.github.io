<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>DHCP</h1><p class=mb-1>November 11, 2017</p><p>&mdash;</p></div><div class=content><h1 id=dhcp>DHCP</h1><p>DHCP（Dynamic Host Configuration Protocol），屬於第七層的 Application Layer。DHCP 此協定運作於 Server-Client 的架構之中，來讓 Client 端取得網路相關的設定，包含 <code>IP Address</code>、<code>Default Route</code>、<code>DNS</code>。Client 端指的是一般電腦設備，而 Server 端就是DHCP Server。</p><h2 id=優點>優點</h2><ol><li>有效節省 IP</li><li>減少維護者負擔</li><li>容易維護</li></ol><h2 id=dhcp-的-port>DHCP 的 port</h2><ul><li>DHCP Server<ul><li>UDP 67</li></ul></li><li>Client<ul><li>UDP 68</li></ul></li></ul><h2 id=dhcp-分配allocateip-位址方式>DHCP 分配（Allocate）IP 位址方式</h2><ol><li>動態分配方式
DHCP Server 上設定好一個 IP Address 範圍以及使用期限，以便回收 IP Address，以便給其它 Client。</li><li>靜態分配方式
DHCP Server 根據已定義並手動寫入對應表的 MAC 位址與 IP 位址來分配。</li><li>自動分配方式
DHCP Server 可以針對事先已經定義好的 IP Address 範圍來分配 IP Address 給 Client 端，IPAddress 的使用是沒有期限，相對的DHCP Server 會記錄 Client 端使用的 IP Address，以避免 IP Address 衝突。</li></ol><h2 id=client-取得-dhcp-設定過程>Client 取得 DHCP 設定過程</h2><p><img src=https://i.imgur.com/SodKH5g.png alt=wiki></p><h5 id=discoveryclient端dhcp-server>Discovery（Client端→DHCP Server）</h5><p>Client 端以 Broadcast 找尋 DHCP Server。設定 DHCP Relay Agent，以達到跨網路尋求的步驟。</p><h5 id=offerdhcp-serverclient端>Offer（DHCP Server→Client端）</h5><p>DHCP Server 接收 Discovery 之後，DHCP Server 會回傳一個 MAC 位址和其它網路設定資料（Subnet Mask、Default Route Address以及 DHCP Server Address 等等）。</p><h5 id=requestclient端dhcp-server>Request（Client端→DHCP Server）</h5><p>Client 端獲取 Offer 網路封包後，此時這用戶端就知道要合作的 DHCP Server 在哪， 會發送 Broadcast，因為 Client 端必須要讓其他 DHCP Server 知道有 DHCP Server 在幫忙。</p><h5 id=acknowledgedhcp-serverclient端>Acknowledge（DHCP Server→Client端）</h5><p>確認時效以及所有其他設定資料，TCP/IP 在 DHCP 之下就完成。</p><h2 id=封包格式>封包格式</h2><p><img src=https://i.imgur.com/JrXhCh6.png alt></p><h5 id=op>OP</h5><p>1：Client 端送出
2：Server 端送出</p><h5 id=htype>htype</h5><p>網路類型
1：Ethernet</p><h5 id=hlen>hlen</h5><p>MAC 長度
Ethernet：6</p><h5 id=hops>Hops</h5><p>Client 端將封包送出，此值為 0
Relay Agent 轉送到 DHCP Server 時加 1</p><h5 id=xid>Xid</h5><p>Client 端藉由此數字，分辨 DHCP Server 所回應的是哪一個封包。</p><h5 id=ciaddr>CIADDR</h5><p>Client IP address</p><h5 id=yiaddr>YIADDR</h5><p>Your IP address</p><h5 id=siaddr>SIADDR</h5><p>Server IP address</p><h5 id=giaddr>GIADDR</h5><p>Gateway IP address</p><h5 id=chaddr>CHADDR</h5><p>Client hardware address</p><h2 id=實作>實作</h2><p>跳過 Route 上的介面 IP 設定。</p><p><img src=https://i.imgur.com/i7SmizB.png alt></p><h5 id=r1dhcp-server>R1（DHCP Server）</h5><p>以下示範（圖資7樓），其餘類似（圖資五樓、行政）</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>DHCP_Server<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip dhcp pool CSIE</span>
DHCP_Server<span style=color:#f92672>(</span>dhcp-config<span style=color:#f92672>)</span><span style=color:#75715e># network 192.168.23.64 255.255.255.192 # 要派出去的 IP 範圍</span>
DHCP_Server<span style=color:#f92672>(</span>dhcp-config<span style=color:#f92672>)</span><span style=color:#75715e>#default-router 192.168.23.126       # Default Gateway</span>
DHCP_Server<span style=color:#f92672>(</span>dhcp-config<span style=color:#f92672>)</span><span style=color:#75715e>#dns-server 192.168.12.101 192.168.12.102 # DNS Server</span>
DHCP_Server<span style=color:#f92672>(</span>dhcp-config<span style=color:#f92672>)</span><span style=color:#75715e>#lease 7 # 租用天數</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip dhcp excluded-address 192.168.23.120 192.168.23.126 # 120~126保留</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip dhcp excluded-address 192.168.23 62 # 保留</span>
</code></pre></div><h5 id=r1組態>R1（組態）</h5><p>使用 <code>Show runn</code> 指令</p><p><img src=https://i.imgur.com/x8ORvzE.png alt></p><h5 id=pc4取得-dhcp>PC4（取得 DHCP）</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>PC4&gt; ip dhcp
</code></pre></div><p><img src=https://i.imgur.com/7KA0WKM.png alt></p><h3 id=dhcp-relay>DHCP Relay</h3><p><code>DHCP</code> 靠 <code>broadcast</code> 傳送，如果 DHCP Server 與 Client 端不在同一個網段，就無法連接，<code>Route</code> 會阻擋 <code>broadcast</code>。得靠 <code>DHCP Relay</code>。
記得，要被 Relay 的 <code>Route</code> 要設置路由協定，讓它能跟 <code>DHCP Server</code> 通訊，否則封包傳送不到。</p><h5 id=r3-00>R3 0/0</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>interface FastEthernet0/0
ip address 192.168.23.190 255.255.255.192
ip helper-address 192.168.22.1 <span style=color:#75715e># ip 填上 DHCP Server IP。</span>
</code></pre></div><h5 id=pc8>PC8</h5><p><img src=https://i.imgur.com/Uu7LOcj.png alt></p><h3 id=查看-dhcp-server-指派的-ip>查看 DHCP Server 指派的 IP</h3><p>DHCP Server 下以下指令</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Show ip dhcp binding
</code></pre></div><p><img src=https://i.imgur.com/fhgRFn1.png alt></p><h3 id=wireshark-查看-sw1-e6-到-pc5-介面流量>Wireshark 查看 SW1 e6 到 PC5 介面流量</h3><p><img src=https://i.imgur.com/hYTkPl5.png alt></p><p>發現 <code>Discovery</code>（frame 4）和 <code>Request</code>（frame 6）以 <code>Broadcast</code> 發送。</p><h5 id=查看-frame-4-封包內容discovery>查看 Frame 4 封包內容（Discovery）</h5><p>（Client端→DHCP Server）</p><ul><li>UDP Protocol
<img src=https://i.imgur.com/MwThH4h.png alt>
使用 <code>UDP</code> 發送，在對應上（DHCP 所使用的 Port）。</li><li>Bootstrap Protocol
<img src=https://i.imgur.com/mIRDTRN.png alt>
DHCP Clien Broadcast 要求，DHCP Server 變成 <code>Unicast</code> 回應。</li></ul><h5 id=查看-frame-5-封包offer>查看 Frame 5 封包（Offer）</h5><p>（DHCP Server→Client端）
<img src=https://i.imgur.com/TKNpHFL.png alt></p><p>Unicast 回應，給了 <code>IP</code>、<code>lease Time</code>、<code>Subnet Mask</code>、<code>DNS</code> 等資訊。如下：
<img src=https://i.imgur.com/28tgwpE.png alt></p><h5 id=查看frame-6封包request>查看Frame 6封包（Request）</h5><p>（Client端→DHCP Server）
<img src=https://i.imgur.com/eWC8N8q.png alt>
省略前半部內容（幾乎一樣的內容 <code>Boot Reply</code> 需要注意）。
以下查看 Option 內容</p><p><img src=https://i.imgur.com/lFAfUAS.png alt></p><h3 id=sw3-e7--pc7-查看-dhcp-relay-agent-流量>SW3 e7 > PC7 查看 DHCP Relay agent 流量</h3><p><img src=https://i.imgur.com/muYrf2E.png alt>
這邊的 <code>DHCP</code> 是有做 <code>Relay agent</code>。</p><h5 id=查看-frame-38封包offer>查看 Frame 38封包（Offer）</h5><p><img src=https://i.imgur.com/42Ojhcn.png alt></p><p>多了 Relay agent IP Address 位址。再往下看</p><p><img src=https://i.imgur.com/iXYJzBE.png alt></p><p>DHCP Server Identifier 是我設定 192.168.22.1 DHCP Server位址。其餘封包內容跟一般 DHCP 大同小異。</p><h2 id=參考資料>參考資料</h2><p><a href=https://www.wikiwand.com/en/Dynamic_Host_Configuration_Protocol#/Operation>wikiwand</a>
<a href=https://www.ietf.org/rfc/rfc2131.txt>ietf</a>
<a href="http://www.netadmin.com.tw/article_content.aspx?sn=1312090004&jump=1">netadmin</a>
<a href=http://www.tech-faq.com/dhcp-leasing.html>link</a></p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/blog/2017-11-04-ppp/ title=PPP><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/blog/2017-11-24-static-route/ title="Static routes"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
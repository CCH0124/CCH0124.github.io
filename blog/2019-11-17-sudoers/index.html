<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>淺談 sudoers</h1><p class=mb-1>November 17, 2019</p><p>&mdash;</p></div><div class=content><h2 id=描述>描述</h2><p>因為在學校要做資訊安全的報告，因此對帳號提權部分做了一點研究。本篇會對於 <code>sudoers</code> 和 <code>sudo</code> 的使用方式作介紹。主要探討的是為何在安裝 ubuntu 時，設定的使用者會有 <code>sudo</code> 提權的功能。</p><p>對於 <a href=https://cch0124.github.io/sudo-su/>sudo</a> 的描述在先前文章有提過。</p><h2 id=sudoers>sudoers</h2><p>配置檔的預設某些內容，格式為 <code>使用者帳號 登入者的來源主機名稱=(可切換的身份) 可下達的指令</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>...
<span style=color:#75715e># User privilege specification</span>
root    ALL<span style=color:#f92672>=(</span>ALL:ALL<span style=color:#f92672>)</span> ALL

<span style=color:#75715e># Members of the admin group may gain root privileges</span>
%admin ALL<span style=color:#f92672>=(</span>ALL<span style=color:#f92672>)</span> ALL

<span style=color:#75715e># Allow members of group sudo to execute any command</span>
%sudo   ALL<span style=color:#f92672>=(</span>ALL:ALL<span style=color:#f92672>)</span> ALL
...
</code></pre></div><ul><li>使用者帳號<ul><li>可以使用 <code>sudo</code> 帳號名稱</li><li>或者以 <code>%</code> 為開頭表示已 <code>GID</code> 設定</li></ul></li><li>登入者的來源主機名稱<ul><li>限制使用者從特定網路主機連線，才能使用 <code>sudo</code> 指令</li><li>值 <code>ALL</code> 則代表不限制來源主機。</li></ul></li><li>可切換的身份<ul><li>值是填入帳號的 <code>UID</code></li><li>取得這些帳號的權限</li><li><code>ALL</code> 表示任何都可取得</li></ul></li><li>可下達的指令<ul><li>取得提權權限時可下的指令</li><li><code>ALL</code> 表示執行的指令沒被限制</li></ul></li></ul><h2 id=sudo-usage>sudo usage</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo -u <span style=color:#f92672>[</span>UID<span style=color:#f92672>]</span> ls <span style=color:#f92672>[</span>FILE_PATH<span style=color:#f92672>]</span> <span style=color:#75715e># 取得該 UID 的權限，並執行指令</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo -g <span style=color:#f92672>[</span>GID<span style=color:#f92672>]</span> ls <span style=color:#f92672>[</span>FILE_PATH<span style=color:#f92672>]</span> <span style=color:#75715e># 取德該 GID 的權限，並執行指令</span>
</code></pre></div><h2 id=example>Example</h2><p>cch 為安裝時，設定的使用者。test 則是新增的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cch@mars:~$ id cch
uid<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>cch<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>cch<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1000<span style=color:#f92672>(</span>cch<span style=color:#f92672>)</span>,4<span style=color:#f92672>(</span>adm<span style=color:#f92672>)</span>,24<span style=color:#f92672>(</span>cdrom<span style=color:#f92672>)</span>,27<span style=color:#f92672>(</span>sudo<span style=color:#f92672>)</span>,30<span style=color:#f92672>(</span>dip<span style=color:#f92672>)</span>,46<span style=color:#f92672>(</span>plugdev<span style=color:#f92672>)</span>,108<span style=color:#f92672>(</span>lxd<span style=color:#f92672>)</span>
cch@mars:~$ id test
uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span>
</code></pre></div><p>先用 <code>su</code> 做使用者登入切換</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ su -l test
Password:
test@mars:~$
</code></pre></div><p>例如我們用 <code>test</code> 使用者查看 <code>syslog</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>test@mars:~$ head -n <span style=color:#ae81ff>1</span> /var/log/syslog
head: cannot open <span style=color:#e6db74>&#39;/var/log/syslog&#39;</span> <span style=color:#66d9ef>for</span> reading: Permission denied
test@mars:~$ ls -l /var/log/syslog 
-rw-r----- <span style=color:#ae81ff>1</span> syslog adm <span style=color:#ae81ff>392736</span> Nov <span style=color:#ae81ff>17</span> 01:46 /var/log/syslog
</code></pre></div><p>出現以下訊息，簡單來說就是無權限，因此要至 <code>sudoers</code> 配置</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>test@mars:~$ sudo head -n <span style=color:#ae81ff>1</span> /var/log/syslog
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> test:
test is not in the sudoers file.  This incident will be reported.
test@mars:~$ sudo cat /var/log/syslog
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> test:
test is not in the sudoers file.  This incident will be reported.
</code></pre></div><p>解決方式 1，在 <code>sudoers</code> 中添加</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ test ALL<span style=color:#f92672>=(</span>cch<span style=color:#f92672>)</span> ALL 
</code></pre></div><p>在執行一次</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo  head -n1 /var/log/syslog
Sorry, user test is not allowed to execute <span style=color:#e6db74>&#39;/usr/bin/head -n1 /var/log/syslog&#39;</span> as root on mars.
</code></pre></div><p>但我們在 <code>suoders</code> 讓 <code>test</code> 可以切換 <code>cch</code>。因此下達 <code>-u cch</code> 的參數即可成功</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo -u cch head -n1 /var/log/syslog
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> test:
Nov <span style=color:#ae81ff>12</span> 00:56:39 mars kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.15.0-66-generic <span style=color:#f92672>(</span>buildd@lgw01-amd64-044<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 7.4.0 <span style=color:#f92672>(</span>Ubuntu 7.4.0-1ubuntu1~18.04.1<span style=color:#f92672>))</span> <span style=color:#75715e>#75-Ubuntu SMP Tue Oct 1 05:24:09 UTC 2019 (Ubuntu 4.15.0-66.75-generic 4.15.18)</span>
</code></pre></div><p>解決方式二，加至 <code>sudo</code> GID</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cch@mars:~$ sudo addgroup test sudo
Adding user <span style=color:#e6db74>`</span>test<span style=color:#e6db74>&#39; to group `sudo&#39;</span> ...
Adding user test to group sudo
Done.
cch@mars:~$ id test
uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span>,27<span style=color:#f92672>(</span>sudo<span style=color:#f92672>)</span>
</code></pre></div><p>執行結果</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>test@mars:~$ sudo  head -n1 /var/log/syslog
<span style=color:#f92672>[</span>sudo<span style=color:#f92672>]</span> password <span style=color:#66d9ef>for</span> test:
Nov <span style=color:#ae81ff>12</span> 00:56:39 mars kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.15.0-66-generic <span style=color:#f92672>(</span>buildd@lgw01-amd64-044<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 7.4.0 <span style=color:#f92672>(</span>Ubuntu 7.4.0-1ubuntu1~18.04.1<span style=color:#f92672>))</span> <span style=color:#75715e>#75-Ubuntu SMP Tue Oct 1 05:24:09 UTC 2019 (Ubuntu 4.15.0-66.75-generic 4.15.18)</span>
</code></pre></div><p>解決方式三，先在 <code>sudoers</code> 定義以下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ test ALL<span style=color:#f92672>=(</span>ALL:ALL<span style=color:#f92672>)</span> ALL 
</code></pre></div><p>不在 <code>adm</code> 群組和 <code>syslog</code> 使用者下，透過上述設定，並藉由 <code>sudo</code> 提權 <code>adm</code> 群組或 <code>syslog</code> 使用者權限。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo -g adm head -n1 /var/log/syslog
Nov <span style=color:#ae81ff>12</span> 00:56:39 mars kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.15.0-66-generic <span style=color:#f92672>(</span>buildd@lgw01-amd64-044<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 7.4.0 <span style=color:#f92672>(</span>Ubuntu 7.4.0-1ubuntu1~18.04.1<span style=color:#f92672>))</span> <span style=color:#75715e>#75-Ubuntu SMP Tue Oct 1 05:24:09 UTC 2019 (Ubuntu 4.15.0-66.75-generic 4.15.18)</span>
test@mars:~$ id test
uid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>1001<span style=color:#f92672>(</span>test<span style=color:#f92672>)</span>
test@mars:~$ sudo -u syslog head -n1 /var/log/syslog
Nov <span style=color:#ae81ff>12</span> 00:56:39 mars kernel: <span style=color:#f92672>[</span>    0.000000<span style=color:#f92672>]</span> Linux version 4.15.0-66-generic <span style=color:#f92672>(</span>buildd@lgw01-amd64-044<span style=color:#f92672>)</span> <span style=color:#f92672>(</span>gcc version 7.4.0 <span style=color:#f92672>(</span>Ubuntu 7.4.0-1ubuntu1~18.04.1<span style=color:#f92672>))</span> <span style=color:#75715e>#75-Ubuntu SMP Tue Oct 1 05:24:09 UTC 2019 (Ubuntu 4.15.0-66.75-generic 4.15.18)</span>
</code></pre></div><h2 id=結論>結論</h2><p>從上述的結果來看 <code>cch</code> 使用者因為有再 <code>sudo</code> GID，因此可以用 <code>sudo</code> 做提權。那 <code>test</code> 使用者則是要透過指令將 <code>sudo</code> GID 加至 <code>test</code> 或者可針對可予以切換的使用者或群組作設定，讓該 <code>test</code> 透過 <code>sudo -u</code> 或 <code>sudo -g</code> 做權限切換動作。</p><p><code>sudoers</code> 是一個可針對使用者能做的事情做限制，善加利用的話也可以達到安全防護效果。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/blog/2019-11-10-vlan/ title="VLAN 介紹"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/blog/2019-12-12-rm-exclude-file/ title="How exclude file ?"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
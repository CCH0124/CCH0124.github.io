<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>NAT</h1><p class=mb-1>January 1, 0001</p><p>&mdash;</p></div><div class=content><h2 id=什麼是-nat>什麼是 NAT</h2><p>因為 IPv4 的地址將用盡，如果沒有 <code>NAT</code> 技術的話將導致某一些人無法存取網路。在 <code>ISP</code> 提供的 IP 可分為，動態 IP 與靜態 IP。動態 IP 可以想成從 <code>ISP</code> 那邊自動獲取 IP 類似於 <code>DHCP</code>；靜態 IP 就是給一個 Global IP 位置且它是收費的。隨著物聯網裝置的需求想必 IPv4 是不夠用，因此就有 NAT 去提升效率，藉由一個 Global IP 來對其下的組織或客戶端實現 <code>NAT</code> 並存取網際網路。</p><p><code>NAT</code> 通常會配置兩個網路，該 <code>NAT</code> 可以隱藏內部訊息，其流程大致上是把私有 IP 轉換為 Global IP，在將其封包轉發至目的地，這樣也就提供對內的安全性。</p><p><code>NAT</code> 可以幫忙解決 IPv4 不足問題也可以有隱藏 IP 功能提高安全性。但它也會有一些缺點，像是要保留傳入與傳出的 IPv4 這將對記憶體或 CPU 帶來負擔，因為多了 <code>NAT</code> 轉換想必延遲一定會有，除此之外它變得不可追溯，因此在做除錯時會帶來麻煩。</p><h2 id=環境設置>環境設置</h2><p>下圖為實驗環境，兩台客戶端和一台可通往 Cloud1 的 ISP。</p><figure><img src=/images/GNS3/NAT.png width=auto height=auto></figure><p>兩台客戶端使用 Vmware 虛擬機網路都為同一個 <code>host only</code>，接著用 <code>netplan</code> 配置虛擬機 <code>IP</code> 和 <code>gateway</code>，這 <code>gateway</code> 將會是 R1 的 <code>f0/0</code> 接口的 IP，這邊有 <code>netplan</code> 教學<a href=https://blog.gtwang.org/linux/ubuntu-linux-1804-configure-network-static-ip-address-tutorial/>鏈結</a>。圖中的 Cloud1 使用 Vmware 提供的可上網的<em>網路適配器</em>，記住上圖的 IP 設置應當依照實驗環境而設置。</p><h2 id=cloud1-的適配器配置>Cloud1 的適配器配置</h2><p>右鍵 -> Configure，接著會有下圖視窗。因為預設似乎是藍芽，這邊要勾選左下角的 <code>Show special Etherenet interface</code>，之後在藍芽網路連線的下拉式選單選擇要的適配器，在點選 <code>Add</code> 這樣 Cloud1 就會有配置的網路適配器。</p><p><img src=https://i.imgur.com/RADCvwf.png alt></p><h2 id=配置-r1>配置 R1</h2><p>如果客戶端都配置完成後，我們將對 R1 進行如下配置。</p><h3 id=配置接口-f00>配置接口 f0/0</h3><pre><code>R1#configure terminal
Enter configuration commands, one per line.  End with CNTL/Z.
R1(config)#interface fa0/0
R1(config-if)#ip address 192.168.245.254 255.255.255.0
R1(config-if)#no shutdown
R1(config-if)#ip nat inside
</code></pre><h3 id=配置接口-f10>配置接口 f1/0</h3><p>f1/0 應當要和 Cloud1 同一網段，因此這邊使用 <code>DHCP</code> 方式對 Cloud1 進行 IP 請求。</p><pre><code>R1#configure terminal
Enter configuration commands, one per line.  End with CNTL/Z.
R1(config)#interface fastEthernet 1/0
R1(config-if)#ip address dhcp 
R1(config-if)#ip nat outside
R1(config-if)#no shutdown
</code></pre><blockquote><p>inside 的配置通常是指內部組織，outside 則是連接網際網路</p></blockquote><h3 id=查看是否配置-ip-至接口上>查看是否配置 IP 至接口上</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#do sh ip int brief</span>
Interface                  IP-Address      OK? Method Status                Protocol
FastEthernet0/0            192.168.245.254 YES manual up                    up
FastEthernet1/0            192.168.134.138 YES DHCP   up                    up
NVI0                       192.168.245.254 YES unset  up                    up <span style=color:#75715e># nat 接口</span>
</code></pre></div><h3 id=配置相關-nat>配置相關 NAT</h3><p>使用 <code>access-list</code> 方式限制可存取的 <code>LAN</code>。再建立一個 NAT 的 IP <code>pool</code>，該 <code>pool</code> 是配置 Cloud1 分配的 IP 地址範圍。當 LAN 進行外網的訪問時將會透過 NAT 機制將 IP 替換 <code>pool</code> 中的 IP 以進行外網存取。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#access-list 1 permit 192.168.245.0 0.0.0.255</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip nat pool DYNAMICNAT 192.168.134.100 192.168.134.120 netmask 255.255.255.0</span>
R1<span style=color:#f92672>(</span>config<span style=color:#f92672>)</span><span style=color:#75715e>#ip nat inside source list 1 pool DYNAMICNAT</span>
</code></pre></div><blockquote><p>動態 NAT 與靜態的差異是在於控制一個 pool 中多個 IP</p></blockquote><h2 id=實驗>實驗</h2><p>R1 嘗試對 google DNS 進行 <code>ping</code>，結果如下是通的。同時間虛擬機也嘗試 ping <code>gateway</code> 也就是 R1 的 f0/0，如果是失敗的需要檢查虛擬機網路配置。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1#ping 8.8.8.8

Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 8.8.8.8, timeout is <span style=color:#ae81ff>2</span> seconds:
..!!!
Success rate is <span style=color:#ae81ff>60</span> percent <span style=color:#f92672>(</span>3/5<span style=color:#f92672>)</span>, round-trip min/avg/max <span style=color:#f92672>=</span> 92/98/104 ms
</code></pre></div><p>虛擬機嘗試 <code>ping 8.8.8.8</code> 如果是成功的話表示說有藉由 NAT 方式進行轉址，並藉由 Cloud1 的網段出去至 8.8.8.8，結果應當如下圖</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ping 8.8.8.8
</code></pre></div><p><img src=https://i.imgur.com/W6AlAsE.png alt></p><h3 id=nat-資訊觀察>NAT 資訊觀察</h3><p>我們在虛擬機嘗試用 <code>ping</code> 對 8.8.8.8 做請求。透過 R1 的 NAT 資訊來驗證是否有做 NAT 動作，下面結果顯示說虛擬機的 IP 被轉為 <code>Inside global</code> IP。也就是虛擬機使用 <code>DYNAMICNAT</code> pool 中所定義的閒置 IP，以下面結果來說是將 <code>192.168.245.8</code> 轉成 <code>192.168.134.101</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1#show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44446  8.8.8.8:44446
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44447  8.8.8.8:44447
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44448  8.8.8.8:44448
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44449  8.8.8.8:44449
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44450  8.8.8.8:44450
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44451  8.8.8.8:44451
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44452  8.8.8.8:44452
udp 192.168.134.101:59162 192.168.245.8:59162 8.8.8.8:44453  8.8.8.8:44453
--- 192.168.134.101    192.168.245.8      ---                ---
--- 192.168.134.100    192.168.245.10     ---                ---
</code></pre></div><p>在做 NAT 時 IP 會有前後因此可用 <code>local</code> 或是 <code>global</code> 來定義。當企業內部組織的主機位於 <code>Inside</code>，連上網路的則為 <code>Outside</code>，其做轉換前會被記錄至 <code>Inside local</code>，被轉換後則是 <code>Inside global</code>。這邊可以想一下說在 R1 <code>Inside</code> 位置會先轉換在路由，而 <code>Outside</code> 則是相反。</p><p>下面是 NAT 統計訊息，<code>cisco</code> 文章說名此統計訊息會有延遲問題，這是隨著 NAT 轉址的數量而變化。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>R1#show ip nat statistics
Total active translations: <span style=color:#ae81ff>31</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span> static, <span style=color:#ae81ff>31</span> dynamic; <span style=color:#ae81ff>29</span> extended<span style=color:#f92672>)</span>
Peak translations: 31, occurred 00:02:48 ago
Outside interfaces:
  FastEthernet1/0
Inside interfaces:
  FastEthernet0/0
Hits: <span style=color:#ae81ff>67</span>  Misses: <span style=color:#ae81ff>0</span>
CEF Translated packets: 66, CEF Punted packets: <span style=color:#ae81ff>1</span>
Expired translations: <span style=color:#ae81ff>3</span>
Dynamic mappings:
-- Inside Source
<span style=color:#f92672>[</span>Id: 1<span style=color:#f92672>]</span> access-list <span style=color:#ae81ff>1</span> pool DYNAMICNAT refcount <span style=color:#ae81ff>31</span>
 pool DYNAMICNAT: netmask 255.255.255.0
        start 192.168.134.100 end 192.168.134.120
        type generic, total addresses 21, allocated <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>9%<span style=color:#f92672>)</span>, misses <span style=color:#ae81ff>0</span>
Appl doors: <span style=color:#ae81ff>0</span>
Normal doors: <span style=color:#ae81ff>0</span>
Queued Packets: <span style=color:#ae81ff>0</span>
</code></pre></div><h2 id=參考資源>參考資源</h2><ul><li><a href=https://www.cisco.com/c/en/us/support/docs/ip/network-address-translation-nat/8605-13.html>cisco nat</a></li><li><a href=https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipaddr_nat/configuration/xe-16/nat-xe-16-book/iadnat-addr-consv.html>cisco nat book</a></li></ul></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/blog/2018-08-03-port-scanner/ title="port scanner"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/blog/2018-08-19-cdp/ title=CDP><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Spring security - user logout 與自動登入</h1><p class=mb-1>October 30, 2021</p><p>&mdash;</p></div><div class=content><h2 id=logout>logout</h2><p>以下是一個使用者登出後的配置，登出成功後頁面會跳轉到 <code>/api/v1/index</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>HttpSecurity http<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#75715e>// TODO Auto-generated method stub
</span><span style=color:#75715e></span>        <span style=color:#75715e>// logout
</span><span style=color:#75715e></span>        http<span style=color:#f92672>.</span><span style=color:#a6e22e>logout</span><span style=color:#f92672>().</span><span style=color:#a6e22e>logoutUrl</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/logout&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>logoutSuccessUrl</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/api/v1/index&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>permitAll</span><span style=color:#f92672>();</span>
        http<span style=color:#f92672>.</span><span style=color:#a6e22e>exceptionHandling</span><span style=color:#f92672>().</span><span style=color:#a6e22e>accessDeniedPage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/403.html&#34;</span><span style=color:#f92672>);</span>
        http<span style=color:#f92672>.</span><span style=color:#a6e22e>formLogin</span><span style=color:#f92672>()</span> <span style=color:#75715e>// 自定義編寫登入頁面
</span><span style=color:#75715e></span>            <span style=color:#f92672>...</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>撰寫一個登出頁面如下，同時也修改上面的 <code>defaultSuccessUrl</code> 配置將其換成 <code>defaultSuccessUrl("/success.html")</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
&lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;Success&lt;/<span style=color:#f92672>title</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;
&lt;<span style=color:#f92672>body</span>&gt;
    &lt;<span style=color:#f92672>h1</span>&gt;Success&lt;/<span style=color:#f92672>h1</span>&gt;
    &lt;<span style=color:#f92672>br</span>&gt;
    &lt;<span style=color:#f92672>a</span> <span style=color:#a6e22e>href</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/logout&#34;</span>&gt;&lt;<span style=color:#f92672>b</span>&gt;logout&lt;/<span style=color:#f92672>b</span>&gt;&lt;/<span style=color:#f92672>a</span>&gt;
&lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><p>實驗過程可以請求 <code>http://localhost:8080/login.html</code> 會跳轉到 <code>http://localhost:8080/success.html</code> 此時可以進行頁面的 API 請求。</p><h2 id=自動登入>自動登入</h2><p>要實現的話會將數據儲存自 <code>cookie</code> 與 <code>database</code>，並進行比對。整體架構如下</p><pre><code> ________________                                                                _____________________________
|                |             _____________________________________            |                            |
|                |  1         |                                    |      2     |                            |
|                |-----------&gt;| UsernamePassworAuthenticationFilter|-----------&gt;|                            |
|                |            |____________________________________|            |                            |
|                |                                                              |    ___________________     |                  ________
|                |                                                              |    | RemeberMeService|     |                 |        |
|    browser     |                                                              |    |_________________|     |       4         |        |
|                |                            3                                 |    ___________________     | --------------&gt; |   DB   |
|                |&lt;-------------------------------------------------------------|    |  TokenRepository|     |       13        |        |
|                |                                                              |    |_________________|     | --------------&gt; |________|
|                |                                                              |                            |                 
|                |             _____________________________________            |                            |
|                |  11        |                                    |            |                            |                 ______________________
|                |            |                                    |     12     |                            |       14       |                     |
|                |-----------&gt;|   RememberMeAuthenticationFilter   |-----------&gt;|                            | --------------&gt;|  UserDetailsService |
|________________|            |____________________________________|            |____________________________|                |_____________________|
</code></pre><p>初始請求</p><ol><li>認證請求</li><li>認證成功，調用 <code>successfulAuthentication</code></li><li>將 Token 寫入瀏覽起的 cookie</li><li>將 Token 寫入 DB
在發送請求</li><li>服務請求</li><li>讀取 cookie 中的 Token</li><li>查找 Token</li></ol><p>在 <code>UsernamePasswordAuthenticationFilter</code> 所繼層的抽象類 <code>AbstractAuthenticationProcessingFilter</code> 中有一個 <code>successfulAuthentication</code> 方法，裡面有一個 <code>rememberMeServices</code> 它調用了 <code>loginSuccess</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>successfulAuthentication</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain chain<span style=color:#f92672>,</span>
			Authentication authResult<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ServletException <span style=color:#f92672>{</span>
		SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAuthentication</span><span style=color:#f92672>(</span>authResult<span style=color:#f92672>);</span> <span style=color:#75715e>// 獲取當前用戶權限
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isDebugEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>LogMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Set SecurityContextHolder to %s&#34;</span><span style=color:#f92672>,</span> authResult<span style=color:#f92672>));</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>rememberMeServices</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loginSuccess</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> authResult<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventPublisher</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventPublisher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>publishEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InteractiveAuthenticationSuccessEvent<span style=color:#f92672>(</span>authResult<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()));</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>successHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onAuthenticationSuccess</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> authResult<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>而 <code>loginSuccess</code> 實現如下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>loginSuccess</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span>
			Authentication successfulAuthentication<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>rememberMeRequested<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>parameter</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Remember-me login not requested.&#34;</span><span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		onLoginSuccess<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> successfulAuthentication<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>當中在查看 <code>onLoginSuccess</code> 實現，</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>   <span style=color:#75715e>// PersistentTokenBasedRememberMeServices class
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onLoginSuccess</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span>
			Authentication successfulAuthentication<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		String username <span style=color:#f92672>=</span> successfulAuthentication<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>LogMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Creating new persistent login for user %s&#34;</span><span style=color:#f92672>,</span> username<span style=color:#f92672>));</span>
		PersistentRememberMeToken persistentToken <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PersistentRememberMeToken<span style=color:#f92672>(</span>username<span style=color:#f92672>,</span> generateSeriesData<span style=color:#f92672>(),</span>
				generateTokenData<span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>());</span>
		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tokenRepository</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createNewToken</span><span style=color:#f92672>(</span>persistentToken<span style=color:#f92672>);</span> <span style=color:#75715e>// 建立 Token
</span><span style=color:#75715e></span>			addCookie<span style=color:#f92672>(</span>persistentToken<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span> <span style=color:#75715e>// 新增至 cookie
</span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failed to save persistent token &#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
	<span style=color:#f92672>}</span>

</code></pre></div><p>在往 <code>JdbcTokenRepositoryImpl</code> 追，可以知道說 <code>createNewToken</code> 與資料庫的交互</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createNewToken</span><span style=color:#f92672>(</span>PersistentRememberMeToken token<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		getJdbcTemplate<span style=color:#f92672>().</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>insertTokenSql</span><span style=color:#f92672>,</span> token<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>(),</span> token<span style=color:#f92672>.</span><span style=color:#a6e22e>getSeries</span><span style=color:#f92672>(),</span> token<span style=color:#f92672>.</span><span style=color:#a6e22e>getTokenValue</span><span style=color:#f92672>(),</span>
				token<span style=color:#f92672>.</span><span style=color:#a6e22e>getDate</span><span style=color:#f92672>());</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>接著再次請求後會觸發 <code>RememberMeAuthenticationFilter</code>，其裡面 <code>doFilter</code> 方法它做了以下事情</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain chain<span style=color:#f92672>)</span>
			<span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ServletException <span style=color:#f92672>{</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>LogMessage
					<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;SecurityContextHolder not populated with remember-me token, as it already contained: &#39;&#34;</span>
							<span style=color:#f92672>+</span> SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#f92672>));</span>
			chain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		Authentication rememberMeAuth <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>rememberMeServices</span><span style=color:#f92672>.</span><span style=color:#a6e22e>autoLogin</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span> <span style=color:#75715e>// 自動登入，會從 cookie 拿值判別是否為空
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rememberMeAuth <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#75715e>// Attempt authenticaton via AuthenticationManager
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
				rememberMeAuth <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>authenticationManager</span><span style=color:#f92672>.</span><span style=color:#a6e22e>authenticate</span><span style=color:#f92672>(</span>rememberMeAuth<span style=color:#f92672>);</span>
				<span style=color:#75715e>// Store to SecurityContextHolder
</span><span style=color:#75715e></span>				SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>setAuthentication</span><span style=color:#f92672>(</span>rememberMeAuth<span style=color:#f92672>);</span>
				onSuccessfulAuthentication<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> rememberMeAuth<span style=color:#f92672>);</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>LogMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;SecurityContextHolder populated with remember-me token: &#39;&#34;</span>
						<span style=color:#f92672>+</span> SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span><span style=color:#f92672>));</span>
				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventPublisher</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
					<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventPublisher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>publishEvent</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InteractiveAuthenticationSuccessEvent<span style=color:#f92672>(</span>
							SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()));</span>
				<span style=color:#f92672>}</span>
				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>successHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
					<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>successHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onAuthenticationSuccess</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> rememberMeAuth<span style=color:#f92672>);</span>
					<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
				<span style=color:#f92672>}</span>
			<span style=color:#f92672>}</span>
			<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AuthenticationException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>LogMessage
						<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SecurityContextHolder not populated with remember-me token, as AuthenticationManager &#34;</span>
								<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;rejected Authentication returned by RememberMeServices: &#39;%s&#39;; &#34;</span>
								<span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;invalidating remember-me token&#34;</span><span style=color:#f92672>,</span> rememberMeAuth<span style=color:#f92672>),</span>
						ex<span style=color:#f92672>);</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>rememberMeServices</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loginFail</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
				onUnsuccessfulAuthentication<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
			<span style=color:#f92672>}</span>
		<span style=color:#f92672>}</span>
		chain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p><code>autoLogin</code> 邏輯</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Authentication <span style=color:#a6e22e>autoLogin</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		String rememberMeCookie <span style=color:#f92672>=</span> extractRememberMeCookie<span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rememberMeCookie <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Remember-me cookie detected&#34;</span><span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>rememberMeCookie<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cookie was empty&#34;</span><span style=color:#f92672>);</span>
			cancelCookie<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
			String<span style=color:#f92672>[]</span> cookieTokens <span style=color:#f92672>=</span> decodeCookie<span style=color:#f92672>(</span>rememberMeCookie<span style=color:#f92672>);</span> <span style=color:#75715e>// 解密
</span><span style=color:#75715e></span>			UserDetails user <span style=color:#f92672>=</span> processAutoLoginCookie<span style=color:#f92672>(</span>cookieTokens<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>userDetailsChecker</span><span style=color:#f92672>.</span><span style=color:#a6e22e>check</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span> <span style=color:#75715e>// 與 DB 進行比對
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Remember-me cookie accepted&#34;</span><span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span> createSuccessfulAuthentication<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> user<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>CookieTheftException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			cancelCookie<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>throw</span> ex<span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>UsernameNotFoundException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Remember-me login was valid but corresponding user not found.&#34;</span><span style=color:#f92672>,</span> ex<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InvalidCookieException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Invalid remember-me cookie: &#34;</span> <span style=color:#f92672>+</span> ex<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>AccountStatusException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Invalid UserDetails: &#34;</span> <span style=color:#f92672>+</span> ex<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RememberMeAuthenticationException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>ex<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>());</span>
		<span style=color:#f92672>}</span>
		cancelCookie<span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
	<span style=color:#f92672>}</span>
</code></pre></div><h2 id=實作自動登入>實作自動登入</h2><p>建立一張 SQL 表</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> <span style=color:#66d9ef>public</span>.persistent_logins (
    username varchar(<span style=color:#ae81ff>64</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    series varchar(<span style=color:#ae81ff>64</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,
    token varchar(<span style=color:#ae81ff>64</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
    last_used <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>CURRENT_TIMESTAMP</span>
);
</code></pre></div><p>調整 <code>JdbcTokenRepositoryImpl</code> 的數據來源</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> DataSource dataSource<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>public</span> PersistentTokenRepository <span style=color:#a6e22e>persistentTokenRepository</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        JdbcTokenRepositoryImpl jdbcTokenRepositoryImpl <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> JdbcTokenRepositoryImpl<span style=color:#f92672>();</span>
        jdbcTokenRepositoryImpl<span style=color:#f92672>.</span><span style=color:#a6e22e>setDataSource</span><span style=color:#f92672>(</span>dataSource<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> jdbcTokenRepositoryImpl<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>在 <code>configure</code> 新增以下以實現自動登入</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>HttpSecurity http<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        <span style=color:#f92672>...</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>and</span><span style=color:#f92672>().</span><span style=color:#a6e22e>rememberMe</span><span style=color:#f92672>().</span><span style=color:#a6e22e>tokenRepository</span><span style=color:#f92672>(</span>persistentTokenRepository<span style=color:#f92672>())</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>tokenValiditySeconds</span><span style=color:#f92672>(</span>60<span style=color:#f92672>)</span> <span style=color:#75715e>// 設置有效時間
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>userDetailsService</span><span style=color:#f92672>(</span>userDetailsService<span style=color:#f92672>)</span>
        <span style=color:#f92672>...</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>修正先前的 <code>login.html</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
&lt;<span style=color:#f92672>head</span>&gt;
    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
    &lt;<span style=color:#f92672>title</span>&gt;Title&lt;/<span style=color:#f92672>title</span>&gt;
&lt;/<span style=color:#f92672>head</span>&gt;
&lt;<span style=color:#f92672>body</span>&gt;
    &lt;<span style=color:#f92672>form</span> <span style=color:#a6e22e>action</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/user/login&#34;</span> <span style=color:#a6e22e>method</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;post&#34;</span>&gt;
        User: &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;username&#34;</span>&gt;
        &lt;<span style=color:#f92672>br</span>&gt;
        Password: &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;password&#34;</span>&gt;
        &lt;<span style=color:#f92672>br</span>&gt;
        &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;checkbox&#34;</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;remember-me&#34;</span>&gt;自動登入 <span style=color:#75715e>&lt;!-- remember-me 必須這樣設置--&gt;</span>
        &lt;<span style=color:#f92672>br</span>&gt;
        &lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;submit&#34;</span> <span style=color:#a6e22e>value</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;login&#34;</span>&gt;
    &lt;/<span style=color:#f92672>form</span>&gt;
&lt;/<span style=color:#f92672>body</span>&gt;
&lt;/<span style=color:#f92672>html</span>&gt;
</code></pre></div><h5 id=測試>測試</h5><p>先到 <code>login.html</code> 頁面，勾選自動登入，使用開發工具可發現在 <code>cookie</code> 中有了 <code>remember-me</code> 的東西</p><p><img src=https://i.imgur.com/pChjFUJ.png alt></p><p>同樣我們到資料庫中也可以發現其幫我們插入了一筆資料</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>cch<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>dt
               List <span style=color:#66d9ef>of</span> relations
 <span style=color:#66d9ef>Schema</span> <span style=color:#f92672>|</span>       Name        <span style=color:#f92672>|</span> <span style=color:#66d9ef>Type</span>  <span style=color:#f92672>|</span>  <span style=color:#66d9ef>Owner</span>
<span style=color:#75715e>--------+-------------------+-------+----------
</span><span style=color:#75715e></span> <span style=color:#66d9ef>public</span> <span style=color:#f92672>|</span> persistent_logins <span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> <span style=color:#f92672>|</span> postgres
 <span style=color:#66d9ef>public</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>user</span>              <span style=color:#f92672>|</span> <span style=color:#66d9ef>table</span> <span style=color:#f92672>|</span> itachi
(<span style=color:#ae81ff>2</span> <span style=color:#66d9ef>rows</span>)

cch<span style=color:#f92672>=#</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> persistent_logins
cch<span style=color:#f92672>-#</span> ;
 username <span style=color:#f92672>|</span>          series          <span style=color:#f92672>|</span>          token           <span style=color:#f92672>|</span>        last_used
<span style=color:#75715e>----------+--------------------------+--------------------------+-------------------------
</span><span style=color:#75715e></span> itachi   <span style=color:#f92672>|</span> pLVn0k8bFK3NoyU6aBvC<span style=color:#f92672>+</span>w<span style=color:#f92672>==</span> <span style=color:#f92672>|</span> SzdGzAWjl3Q1HbMIh7yn0w<span style=color:#f92672>==</span> <span style=color:#f92672>|</span> <span style=color:#ae81ff>2021</span><span style=color:#f92672>-</span><span style=color:#ae81ff>10</span><span style=color:#f92672>-</span><span style=color:#ae81ff>31</span> <span style=color:#ae81ff>12</span>:<span style=color:#ae81ff>50</span>:<span style=color:#ae81ff>12</span>.<span style=color:#ae81ff>814</span>
(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span>)
</code></pre></div></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/code/2021-10-29-spring-security-annotation/ title="Spring security - annotation"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/code/2021-11-02-csrf/ title="Spring security - CSRF(Cross-site request request forgery)"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
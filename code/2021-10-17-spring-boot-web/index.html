<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Spring boot Web 開發</h1><p class=mb-1>October 17, 2021</p><p>&mdash;</p></div><div class=content><p>Spring boot provides auto-configuration for Spring MVC that works well with most applications.</p><h3 id=請求參數處理>請求參數處理</h3><h4 id=請求映射>請求映射</h4><ul><li>RequestMapping<ul><li>value 請求路徑</li><li>method 使用的 HTTP Method</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;path&#34;</span><span style=color:#f92672>,</span> method<span style=color:#f92672>=</span>RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> SomeData <span style=color:#a6e22e>requestMethodName</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestParam</span> String param<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SomeData<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>在 Spring boot 中以下的請求映射都繼層於 <code>RequestMapping</code></p><ul><li>GetMapping</li><li>PostMapping</li><li>DeleteMapping</li><li>PutMapping</li></ul><p><code>DispatcherServlet</code> 是處理所有請求的開始，往上追最後會繼層一個 <code>HttpServlet</code>，當中請求會調用 <code>doGet</code> 方法（如果是 Get 請求），在 <code>DispatcherServlet</code> 中所有請求都會調用 <code>doDispatch(HttpServletRequest request, HttpServletResponse response)</code>。所有請求都存在於 <code>HandlerMapping</code> 中在 Spring boot 中有 5 種，Spring boot 自動配置歡迎頁面的 <code>WelcomePageHandlerMapping</code>，只要請求訪問 <code>/</code> 能訪問到 <code>index.html</code>。請求進來，會嘗試每個 <code>HandlerMapping</code> 查看是否有請求訊息，有就表示找到該請求對應的 <code>HandlerMapping</code>。</p><p>Spring boot 自動配置默認的 <code>RequestMappingHandlerMapping</code>其保存所有<code>@RequestMapping</code> 和 <code>handler</code> 映射規則，還有像是 <code>BeanNameUrlHandlerMapping</code></p><ul><li><code>RouterFunctionMapping</code> 和 <code>SimpleUrlHandlerMapping</code></li></ul><h4 id=普通參數與基本註解>普通參數與基本註解</h4><ul><li>@PathVariable</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> String id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
<span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}/profile/{username}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> pv<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// @PathVariable Map&lt;String, String&gt; pv 會將 id 和 username 封裝至 Map
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@RequestHeader<ul><li>表示獲取 HTTP 請求中的某一個 Header</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> String id<span style=color:#f92672>,</span> <span style=color:#a6e22e>@RequestHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Authorization&#34;</span><span style=color:#f92672>)</span> String authorization<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> String id<span style=color:#f92672>,</span> <span style=color:#a6e22e>@RequestHeader</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> headers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// @RequestHeader Map&lt;String, String&gt; 獲取所有請求 Header
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@RequestParam<ul><li>獲取 HTTP 請求 Path 中的參數，ex: <code>http://localhost:8080/user/{id}?age=18&inters=game&inters=baseball</code></li><li>用於 queryString</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}?age=18&amp;inters=game&amp;inters=baseball&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> String id<span style=color:#f92672>,</span> <span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;age&#34;</span><span style=color:#f92672>)</span> Integer age<span style=color:#f92672>,</span><span style=color:#a6e22e>@RequestParam</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;inters&#34;</span><span style=color:#f92672>)</span> List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> inters<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// @RequestParam Map&lt;String, String&gt; 獲取所有請求參數
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@CookieValue<ul><li>獲取 cookie 的值</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/{id}&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@PathVariable</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>)</span> String id<span style=color:#f92672>,</span> <span style=color:#a6e22e>@CookieValue</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;_ga&#34;</span><span style=color:#f92672>)</span> String _ga<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// @CookieValue(&#34;_ga&#34;) Cookie _ga 方式接收，表示獲取全部 cookie 內容
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@RequestBody<ul><li>表示獲取 HTTP 請求中的 Body，通常建立資料或更新資料時 Body 才會有值</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@PostMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>saveUser</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@RequestAttribute<ul><li>通常用於頁面轉發</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/goto&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>saveUser</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;成功了...&#34;</span><span style=color:#f92672>);</span>
    request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;200&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;forward:/success&#34;</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
<span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/success&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>success</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>)</span> String msg<span style=color:#f92672>,</span> <span style=color:#a6e22e>@RequestAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>)</span> Integer code<span style=color:#f92672>,</span> HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul><li>@MatrixVariable</li></ul><h5 id=參數處理原理>參數處理原理</h5><ul><li><code>HandlerMapping</code> 中找到能處理請求的 Handler (Controller.method)</li><li>為當前 <code>Handler</code> 找一個適配器 <code>HandlerAdapter</code>(RequestMappingHandlerAdapter)</li></ul><p><code>HandlerAdapter</code> 有以下四種方法</p><ul><li>RequestMappingHandlerAdapter<ul><li>支援方法上標示 <code>RequestMapping</code></li></ul></li><li>HandlerFunctionAdapter<ul><li>支援函數式編程</li></ul></li><li>HttpRequestHandlerAdapter</li><li>SimpleControllerHandlerAdapter</li></ul><p><code>HandlerMethodArgumentResolver</code> 是一個參數解析器，確定將要執行的目標方法每一個參數值是什麼，就是解析</p><ul><li>RequestParamMethodArgumentResolver</li><li>PathVariableMethodArgumentResolver</li><li>RequestResponseBodyMethodProcessor</li><li>等</li></ul><p><code>HandlerMethodReturnValueHandlerComposite</code> 處理返回值</p><ul><li>ModelAndViewMethodReturnValueHandler</li><li>ModelMethodProcessor</li><li>ResponseBodyEmitterReturnValueHandler</li><li>等</li></ul><p>在我們的 controller 中的方法也是可以調用 Servlet API</p><ul><li>WebRequest</li><li>ServletRequest</li><li>MultipartRequest</li><li>HttpSession</li><li>javax.servlet.http.PushBuilder</li><li>Principal</li><li>InputStream</li><li>Reader</li><li>HttpMethod</li><li>Locale</li><li>TimeZone</li><li>ZoneId</li><li>etc.</li></ul><p>下面這個範例來說它會匹配 <code>ServletRequestMethodArgumentResolver</code> 這個解析器</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/goto&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>saveUser</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;成功了...&#34;</span><span style=color:#f92672>);</span>
    request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;code&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;200&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;forward:/success&#34;</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>在底層中，會符合 <code>ServletRequest.class</code> 這個物件</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>supportsParameter</span><span style=color:#f92672>(</span>MethodParameter parameter<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		Class<span style=color:#f92672>&lt;?&gt;</span> paramType <span style=color:#f92672>=</span> parameter<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterType</span><span style=color:#f92672>();</span>
		<span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>WebRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				ServletRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				MultipartRequest<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				HttpSession<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				<span style=color:#f92672>(</span>pushBuilder <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> pushBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>))</span> <span style=color:#f92672>||</span>
				Principal<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				InputStream<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				Reader<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>paramType<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
				HttpMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> paramType <span style=color:#f92672>||</span>
				Locale<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> paramType <span style=color:#f92672>||</span>
				TimeZone<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> paramType <span style=color:#f92672>||</span>
				ZoneId<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> paramType<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div><p>相較於複雜參數有可能會帶入這些</p><ul><li>Map</li><li>Model（map、model 裡面的數據會被放在 request 的請求域 <code>request.setAttribute</code>）</li><li>Errors/BindingResult</li><li>RedirectAttributes（重定向攜帶數據）</li><li>ServletResponse（response）</li><li>SessionStatus</li><li>UriComponentsBuilder</li><li>ServletUriComponentsBuilder</li></ul><p>下面的範例，是請求 <code>params</code> 接著轉發至 <code>success</code> 路徑，<code>Map&lt;String, Object> map</code>、<code>Model model</code>、<code>HttpServletRequest request</code> 都可以在 request 請求中放數據</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/params&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>testParam</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> map<span style=color:#f92672>,</span> Model model<span style=color:#f92672>,</span> HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;World&#34;</span><span style=color:#f92672>);</span>
        model<span style=color:#f92672>.</span><span style=color:#a6e22e>addAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;attributeName&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;attributeValue&#34;</span><span style=color:#f92672>);</span>
        request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Hello World&#34;</span><span style=color:#f92672>);</span>
        Cookie c <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Cookie<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;value&#34;</span><span style=color:#f92672>);</span>
        c<span style=color:#f92672>.</span><span style=color:#a6e22e>setDomain</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>);</span>
        response<span style=color:#f92672>.</span><span style=color:#a6e22e>addCookie</span><span style=color:#f92672>(</span>c<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;forward:/success&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span>value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/success&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> Map <span style=color:#a6e22e>success</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Object hello <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>);</span>
        Object attributeName  <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;attributeName&#34;</span><span style=color:#f92672>);</span>
        Object message <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>);</span>
        Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> map <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello&#34;</span><span style=color:#f92672>,</span> hello<span style=color:#f92672>);</span>
        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;attributeName&#34;</span><span style=color:#f92672>,</span> attributeName<span style=color:#f92672>);</span>
        map<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;message&#34;</span><span style=color:#f92672>,</span> message<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> map<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>假設傳入的參數是屬於自定義的話會被 <code>ServletModelAttributeMethodProcessor</code> 進行處理，並判斷類型是否為 <code>SimpleValue</code>，之後還會進入 <code>GenericConversionService</code>，將 request 帶來的參數的字串轉成指定類型。而我們也可以自定義一個 <code>Converter</code> 進行數據轉換。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isSimpleValueType</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span>Void<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>!=</span> type <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>void</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>!=</span> type <span style=color:#f92672>&amp;&amp;</span>
        <span style=color:#f92672>(</span>ClassUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isPrimitiveOrWrapper</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        Enum<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        CharSequence<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        Number<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        Date<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        Temporal<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isAssignableFrom</span><span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
        URI<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> type <span style=color:#f92672>||</span>
        URL<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> type <span style=color:#f92672>||</span>
        Locale<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> type <span style=color:#f92672>||</span>
        Class<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>==</span> type<span style=color:#f92672>));</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=響應-json>響應 JSON</h2><h3 id=jacksonjar-與-responsebody>jackson.jar 與 @ResponseBody</h3><p>我們只要引入 <code>spring-boot-starter-web</code> 就會幫我們引入 <code>json</code> 相關套件。所以我們只要給予 <code>@ResponseBody</code> 就可以給前端返回 <code>json</code> 格式數據。如下範例</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@ResponseBody</span>
<span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span>value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/user&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>saveUser</span><span style=color:#f92672>(</span>User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    user<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Itachi&#34;</span><span style=color:#f92672>);</span>
    user<span style=color:#f92672>.</span><span style=color:#a6e22e>setAge</span><span style=color:#f92672>(</span>18<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> user<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>在一個 API 上有請求處理也同樣有返回值處理(<code>HandlerMethodReturnValueHandlerComposite</code>)，同樣會用下面的方法找到合適的處理器進行處理。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#a6e22e>@Override</span>
  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleReturnValue</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Object returnValue<span style=color:#f92672>,</span> MethodParameter returnType<span style=color:#f92672>,</span>
      ModelAndViewContainer mavContainer<span style=color:#f92672>,</span> NativeWebRequest webRequest<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>

    HandlerMethodReturnValueHandler handler <span style=color:#f92672>=</span> selectHandler<span style=color:#f92672>(</span>returnValue<span style=color:#f92672>,</span> returnType<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>handler <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Unknown return value type: &#34;</span> <span style=color:#f92672>+</span> returnType<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterType</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>
    handler<span style=color:#f92672>.</span><span style=color:#a6e22e>handleReturnValue</span><span style=color:#f92672>(</span>returnValue<span style=color:#f92672>,</span> returnType<span style=color:#f92672>,</span> mavContainer<span style=color:#f92672>,</span> webRequest<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>
</code></pre></div><p>而 <code>selectHandler</code> 合適的處理器有以下</p><ul><li>ModelAndViewMethodReturnValueHandler</li><li>ModelMethodProcessor</li><li>ViewMethodReturnValueHandler</li><li>ResponseBodyEmitterReturnValueHandler</li><li>等</li></ul><p>以上面 API 範例來說最後是使用 <code>RequestResponseBodyMethodProcessor</code> 處理器。接下來會透過 <code>handleReturnValue</code> 進行回應數據的處理，如下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>  <span style=color:#a6e22e>@Override</span>
  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>handleReturnValue</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@Nullable</span> Object returnValue<span style=color:#f92672>,</span> MethodParameter returnType<span style=color:#f92672>,</span>
      ModelAndViewContainer mavContainer<span style=color:#f92672>,</span> NativeWebRequest webRequest<span style=color:#f92672>)</span>
      <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> HttpMediaTypeNotAcceptableException<span style=color:#f92672>,</span> HttpMessageNotWritableException <span style=color:#f92672>{</span>

    mavContainer<span style=color:#f92672>.</span><span style=color:#a6e22e>setRequestHandled</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
    ServletServerHttpRequest inputMessage <span style=color:#f92672>=</span> createInputMessage<span style=color:#f92672>(</span>webRequest<span style=color:#f92672>);</span>
    ServletServerHttpResponse outputMessage <span style=color:#f92672>=</span> createOutputMessage<span style=color:#f92672>(</span>webRequest<span style=color:#f92672>);</span>
    writeWithMessageConverters<span style=color:#f92672>(</span>returnValue<span style=color:#f92672>,</span> returnType<span style=color:#f92672>,</span> inputMessage<span style=color:#f92672>,</span> outputMessage<span style=color:#f92672>);</span>
  <span style=color:#f92672>}</span>
</code></pre></div><p><code>writeWithMessageConverters</code> 則會將數據處理為 json 格式。在一個 HTTP 請求 Header 中有一個欄位是 <code>Accept</code>，表示能接受的內容類型，在轉換 json 格式時會做一個協商，瀏覽器會以該 Header 說它能接收什麼類型的數據內容，接著服務器會依據自己的能力，決定服務器生產出什麼樣的內容類型數據，在 Spring MVC 會遍歷底層的 <code>HttpMessageConverter</code> 看誰能處理，以上面 API 範例來看，就是 User 對象轉 JSON 格式；或是 JSON 轉 User 物件。默認 <code>HttpMessageConverter</code> 有以下</p><ul><li>MappingJackson2HttpMessageConverter</li><li>ByteArrayHttpMessageConverter</li><li>ResourceHttpMessageConverter<ul><li>真對檔案下載等</li></ul></li><li>StringHttpMessageConverter</li><li>等</li></ul><p>其中 <code>MappingJackson2HttpMessageConverter</code> 救世會將物件轉 JSON 格式的處理。整體來說如下</p><pre><code>@ResponseBody -----&gt; RequestResponseBodyMethodProcessor -----&gt; HttpMessageConverter(協商) -----&gt; 轉成對應的資源
</code></pre><p>而協商會根據客戶端接收能力不同，而返回不同類型數據。也就是請求 Header 的 accept 值，如果 <code>*/*</code> 表示所有都可接受預設是 JSON，如要 XML 就 <code>application/xml</code>，這過程會和服務端的 10 種能力(JSON、XML) 等進行最佳匹配。</p><p>在 Spring MVC 可以使用 <code>spring.contentnegotiation.favor-parameter=true</code> 使用 <code>format</code> 進行回應資料的轉換，<code>http://localhost/user?format=xml</code> 或是 <code>http://localhost/user?format=json</code>。在底層協商部分會增加基於 <code>ParameteContentNegotiationStrategy</code> 的策略，因此協商內容不只是依據 HTTP 的 Header 內容。</p><h3 id=自定義-httpmessageconverter>自定義 HttpMessageConverter</h3><p>從上面解析來看</p><ol><li><code>@ResponseBody</code> 響應出去調用 <code>RequestResponseBodyMethodProcessor</code> 處理</li><li><code>Processor</code> 處理方法返回值，透過 <code>HttpMessageConverter</code> 處理</li><li>所有 <code>HttpMessageConverter</code> 可支持各種 <code>Media-Type</code> 類型讀寫操作，最後找到合適的 <code>HttpMessageConverter</code></li></ol><p>如果要自定義可使用 <code>WebMvcConfigurer</code> 物件並覆寫 <code>extendMessageConverters(List&lt;HttpMessageConverter&lt;?>> converters)</code>。要以 <code>format</code> 方式進行處理，則可以透過覆寫<code>configureContentNegotiation(ContentNegotiationConfigurer configurer)</code>，在這之中如果只針對 <code>ParameterContentNegotiationStrategy</code> 進行配置，則 HTTP 的 Header 的可接受數據內容則會失效，因此最好也將 <code>HeaderContentNegotiationStrategy</code> 進行覆寫。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/code/2021-10-17-spring-boot/ title="Spring boot 概觀"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/code/2021-10-17-lombok/ title="lombok 利器"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
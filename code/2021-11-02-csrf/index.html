<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Spring security - CSRF(Cross-site request request forgery)</h1><p class=mb-1>November 2, 2021</p><p>&mdash;</p></div><div class=content><p><code>CSRF</code> 原理網路上有很多解釋這邊不再進一步介紹，推薦<a href=https://www.cloudflare.com/zh-tw/learning/security/threats/cross-site-request-forgery/>cloudflare</a> 所寫的內容。</p><p>在 Spring Security CSRF 會針對 PATCH、POST、PUT 和 DELETE HTTP 方法進行防護。在先前的範例中我們將 CSRF 關閉</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>.</span><span style=color:#a6e22e>and</span><span style=color:#f92672>().</span><span style=color:#a6e22e>csrf</span><span style=color:#f92672>().</span><span style=color:#a6e22e>disable</span><span style=color:#f92672>();</span>
</code></pre></div><p>只要將其拿掉即可開啟 CSRF 防護。</p><h2 id=spring-security-csrf-原理>Spring Security CSRF 原理</h2><p>從 <code>CsrfFilter</code> 類別中查看 <code>doFilterInternal</code> 方法，可以大致清楚知道它的處裡邏輯。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span>
	<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doFilterInternal</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> FilterChain filterChain<span style=color:#f92672>)</span>
			<span style=color:#66d9ef>throws</span> ServletException<span style=color:#f92672>,</span> IOException <span style=color:#f92672>{</span>
		request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>HttpServletResponse<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span> response<span style=color:#f92672>);</span>
		CsrfToken csrfToken <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tokenRepository</span><span style=color:#f92672>.</span><span style=color:#a6e22e>loadToken</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>boolean</span> missingToken <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>csrfToken <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>missingToken<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			csrfToken <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tokenRepository</span><span style=color:#f92672>.</span><span style=color:#a6e22e>generateToken</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tokenRepository</span><span style=color:#f92672>.</span><span style=color:#a6e22e>saveToken</span><span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
		<span style=color:#f92672>}</span>
		request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>CsrfToken<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>(),</span> csrfToken<span style=color:#f92672>);</span>
		request<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterName</span><span style=color:#f92672>(),</span> csrfToken<span style=color:#f92672>);</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>requireCsrfProtectionMatcher</span><span style=color:#f92672>.</span><span style=color:#a6e22e>matches</span><span style=color:#f92672>(</span>request<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isTraceEnabled</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
				<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>trace</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Did not protect against CSRF since request did not match &#34;</span>
						<span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>requireCsrfProtectionMatcher</span><span style=color:#f92672>);</span>
			<span style=color:#f92672>}</span>
			filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		String actualToken <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeader</span><span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getHeaderName</span><span style=color:#f92672>());</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>actualToken <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
			actualToken <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameter</span><span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getParameterName</span><span style=color:#f92672>());</span>
		<span style=color:#f92672>}</span>
		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>equalsConstantTime<span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>.</span><span style=color:#a6e22e>getToken</span><span style=color:#f92672>(),</span> actualToken<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>logger</span><span style=color:#f92672>.</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>(</span>
					LogMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#34;Invalid CSRF token found for &#34;</span> <span style=color:#f92672>+</span> UrlUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>buildFullRequestUrl</span><span style=color:#f92672>(</span>request<span style=color:#f92672>)));</span>
			AccessDeniedException exception <span style=color:#f92672>=</span> <span style=color:#f92672>(!</span>missingToken<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> InvalidCsrfTokenException<span style=color:#f92672>(</span>csrfToken<span style=color:#f92672>,</span> actualToken<span style=color:#f92672>)</span>
					<span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> MissingCsrfTokenException<span style=color:#f92672>(</span>actualToken<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>accessDeniedHandler</span><span style=color:#f92672>.</span><span style=color:#a6e22e>handle</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
			<span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
		<span style=color:#f92672>}</span>
		filterChain<span style=color:#f92672>.</span><span style=color:#a6e22e>doFilter</span><span style=color:#f92672>(</span>request<span style=color:#f92672>,</span> response<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>
</code></pre></div></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/code/2021-10-30-spring-security-user-logout/ title="Spring security - user logout 與自動登入"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><i class="nav-menu-disabled fas fa-chevron-circle-right"></i></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
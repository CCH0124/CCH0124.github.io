<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Spring security - annotation</h1><p class=mb-1>October 29, 2021</p><p>&mdash;</p></div><div class=content><p>註解是為了可以方便讓我們使用，以下將會介紹註解。實驗過程可藉由更改 <code>commaSeparatedStringToAuthorityList</code> 方法所傳遞的權限進行調整</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java> List<span style=color:#f92672>&lt;</span>GrantedAuthority<span style=color:#f92672>&gt;</span> auths <span style=color:#f92672>=</span> AuthorityUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>commaSeparatedStringToAuthorityList</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;admins,ROLE_sale&#34;</span><span style=color:#f92672>);</span>
</code></pre></div><h3 id=secured>@Secured</h3><p>判斷是否具有角色，有的話表示可以存取該方法，這邊匹配的角色需加上 **ROLE_**。在使用註解時須先開啟註解功能 <code>@EnableGlobalMethodSecurity</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@SpringBootApplication</span>
<span style=color:#a6e22e>@EnableGlobalMethodSecurity</span><span style=color:#f92672>(</span>securedEnabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Securitydemo01Application</span> <span style=color:#f92672>{</span>

	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
		SpringApplication<span style=color:#f92672>.</span><span style=color:#a6e22e>run</span><span style=color:#f92672>(</span>Securitydemo01Application<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
	<span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>透過 <code>@Secured</code> 註解可讓該方法被限制只能是 &ldquo;ROLE_sale&rdquo; 或 &ldquo;ROLE_manager&rdquo; 才能存取。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/update&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@Secured</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;ROLE_sale&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#34;ROLE_manager&#34;</span><span style=color:#f92672>})</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>update</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello update&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h3 id=preauthorize>@PreAuthorize</h3><p>進入該方法前的權限驗證，可將登入使用者的 <code>roles/permissions</code> 參數傳到方法中。同樣的要使用該註解必須啟用，在 <code>@EnableGlobalMethodSecurity</code> 添加 <code>prePostEnable=true</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/preAuth&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PreAuthorize</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hasAnyAuthority(&#39;admins&#39;)&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>preAuth</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello preAuth&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>其中 <code>hasAnyAuthority</code> 也可以是 <code>hasAuthority</code>、<code>hasRole</code> 或 <code>hasAnyRole</code> 等，以下整理了一張表</p><table><thead><tr><th>Expression</th><th>Descript</th></tr></thead><tbody><tr><td>hasRole([role])</td><td>當前請求者是否有指定角色</td></tr><tr><td>hasAnyRole([role1, role2])</td><td>當前請求者是否有符合設定的任一角色</td></tr><tr><td>hasAuthority([auth])</td><td>當前請求者是否有指定角色</td></tr><tr><td>hasAnyAuthority([auth1,auth2])</td><td>當前請求者是否有符合設定的任一角色</td></tr><tr><td>Principle</td><td>當前請求者 Principle 物件</td></tr><tr><td>authentication</td><td>從 SecurityContext 獲取當前 authentication</td></tr><tr><td>permitAll</td><td>都允許</td></tr><tr><td>dentAll</td><td>都拒絕</td></tr><tr><td>isAnonymous()</td><td>當前請求者是否為一個匿名使用者</td></tr><tr><td>isRememberMe()</td><td>表示當前請求者是否使用 Remember-Me 自動登入</td></tr><tr><td>isAuthenticated()</td><td>當前使用者是否登入認證成功</td></tr><tr><td>isFullyAuthenticated()</td><td>當前使用者非匿名且不透過 Remember-Me 登入</td></tr></tbody></table><h3 id=postauthorize>@PostAuthorize</h3><p>在方法執行之後驗證權限。適合驗證帶有返回值的權限。同樣的要使用該註解必須啟用，在 <code>@EnableGlobalMethodSecurity</code> 添加 <code>prePostEnable=true</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/postAuth&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PostAuthorize</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hasAnyAuthority(&#39;admins&#39;)&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>postAuth</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;update...&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Hello postAuth&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>同時調整 <code>List&lt;GrantedAuthority> auths = AuthorityUtils.commaSeparatedStringToAuthorityList("ROLE_sale");</code>讓其只有 <code>ROLE_sale</code> 權限。會發現說方法被執行了，但頁面是 403 HTTP Code。</p><h3 id=postfilter>@PostFilter</h3><p>權限驗證之後對數據進行過濾。</p><p>下面範例 <code>filterObject</code> 獲取當前回傳值。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/list&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PreAuthorize</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hasRole(&#39;ROLE_manager&#39;)&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PostFilter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;filterObject.username == &#39;admin1&#39;&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getUserList</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;();</span>
        list<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin1&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;password&#34;</span><span style=color:#f92672>));</span>
        list<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;admin2&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;password&#34;</span><span style=color:#f92672>));</span>

        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h3 id=prefilter>@PreFilter</h3><p>進入 Controller 時對數據進行過濾。與 <code>PostFilter</code> 類似。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/prefilter/list&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PreAuthorize</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hasRole(&#39;ROLE_manager&#39;)&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@PreFilter</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;filterObject.username == &#39;admin1&#39;&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getUserListForPreFilter</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@RequestBody</span> List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> list<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        list<span style=color:#f92672>.</span><span style=color:#a6e22e>forEach</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>::</span>println<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> list<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
</code></pre></div></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/code/2021-10-28-spring-security-overview/ title="Spring security 概觀"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/code/2021-10-30-spring-security-user-logout/ title="Spring security - user logout 與自動登入"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
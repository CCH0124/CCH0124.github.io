<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>Spring boot Web 開發 - Error Handler</h1><p class=mb-1>October 27, 2021</p><p>&mdash;</p></div><div class=content><p>從官方介紹內容來看錯誤處理內從大概是以下</p><ol><li>默認規則</li></ol><ul><li>預設下，Spring boot 提供 <code>/error</code> 處理所有錯誤的映射</li><li>對於非瀏覽器類型，會以 <code>JSON</code> 進行回應，其中包含錯誤、HTTP 狀態和異常訊息；對於瀏覽器則會以 <em>whilelabel</em> 進行視圖回應，會以 HTML 方式呈現</li><li>要自定義，添加 <strong>View 解析為 Error</strong></li><li>要完全替代預設的行為，可以實作 <code>ErrorController</code> 並註冊該類型的 Bean 定義，或添加 <code>ErrorAttributes</code> 類型的組件以替換內容</li></ul><p>異常整體流程處理</p><ol><li>執行目標方法，只要期間有錯誤都會被 JAVA 的 <code>catch</code> 語法給抓到，並將當前請求結束，其過程會進入 <code>dispatchException</code></li><li>進入 <code>processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException)</code></li><li>當中 mv = processHandlerException，處理 handler 發生的異常，接著回傳 <em>ModelAndView</em>，過程會遍歷 <code>handlerExceptionResolvers</code>，看誰能處理，系統默認的解析起有以下</li></ol><ul><li>DefaultErrorAttributes<ul><li>先來處理異常。把異常訊息給 <code>request</code>，並返回 <code>null</code></li></ul></li><li>HandlerExceptionResolveComposite<ul><li>ExceptionHandlerExceptionResolver</li><li>ResponseStatusExceptionResolver</li><li>DefaultHandlerExceptionResolver
預設下沒有東西可以處理異常，因此異常被拋出，最後發送 <code>/error</code> 請求，被底層 <code>BasicErrorController</code> 處理。</li></ul></li></ul><h2 id=定制錯誤邏輯>定制錯誤邏輯</h2><ul><li>自定義錯誤頁面<ul><li>在 error 目錄下進行匹配</li></ul></li><li>@ControllerAdvice+@ExceptionHandler<ul><li>底層是 <code>ExceptionHandlerExceptionResolver</code></li></ul></li><li>@ResponseStatus+自定義異常<ul><li>底層是 <code>ResponseStatusExceptionResolver</code>，把 <code>@ResponseStatus</code> 註解訊息底層調用 <code>response.sendError(statusCode, resolvedReason)</code>，tomcat 發送的 <code>/error</code></li></ul></li><li>Spring 底層異常，如參數類型轉換<ul><li><code>DefaultHandlerExceptionResolver</code> 處理框架的異常</li><li><code>response.sendError (HttpServletResponse.SC_BAD_REQUEST, ex.getMessage())</code></li></ul></li><li>自定義實現 <code>HandlerExceptionResolver</code> 異常處理</li></ul><h3 id=controlleradviceexceptionhandler>@ControllerAdvice+@ExceptionHandler</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@RestControllerAdvice</span>
<span style=color:#a6e22e>@Slf4j</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionHandlerAdvice</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>Exception<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#75715e>// 捕獲的異常，執行這個類別下對應的動作
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>handleException</span><span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;(</span>ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_ERROR</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>(),</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_ERROR</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMsg</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>RuntimeException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>handleRuntimeException</span><span style=color:#f92672>(</span>RuntimeException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;(</span>ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_ERROR</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>(),</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_ERROR</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMsg</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@ExceptionHandler</span><span style=color:#f92672>(</span>BaseException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>handleBaseException</span><span style=color:#f92672>(</span>BaseException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessage</span><span style=color:#f92672>(),</span> e<span style=color:#f92672>);</span>
        ResponseCode code <span style=color:#f92672>=</span> e<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ResponseResult<span style=color:#f92672>&lt;</span>Void<span style=color:#f92672>&gt;(</span>code<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>(),</span> code<span style=color:#f92672>.</span><span style=color:#a6e22e>getMsg</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><h3 id=responsestatus自定義異常>@ResponseStatus+自定義異常</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@ResponseStatus</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> HttpStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>FORBIDDEN</span><span style=color:#f92672>,</span> reason <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;User too many&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> UserTooManyException <span style=color:#66d9ef>extends</span> RuntimeException <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>UserTooManyException</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>UserTooManyException</span><span style=color:#f92672>(</span>String message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>message<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

<span style=color:#a6e22e>@GetMapping</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/user/all&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> something <span style=color:#a6e22e>getUser</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> UserTooManyException<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>return</span> something<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><a href=https://www.baeldung.com/spring-response-status>可參考文章</a></p><h3 id=handlerexceptionresolver-自定義>HandlerExceptionResolver 自定義</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> Ordered<span style=color:#f92672>.</span><span style=color:#a6e22e>HIGHEST_PRECEDENCE</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>@Component</span> <span style=color:#75715e>// 放在容器中
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomHandlerExceptionResolver</span> <span style=color:#66d9ef>implements</span> HandlerExceptionResolver<span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> ModelAndView <span style=color:#a6e22e>resolveException</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>,</span> HttpServletResponse response<span style=color:#f92672>,</span> Object handler<span style=color:#f92672>,</span>
            Exception ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// TODO Auto-generated method stub
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            response<span style=color:#f92672>.</span><span style=color:#a6e22e>sendError</span><span style=color:#f92672>(</span>510<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Error...&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>//TODO: handle exception
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ModelAndView<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

</code></pre></div><p>透過 Oeder 的註解讓當前異常處理優先權為最高。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/code/2021-10-17-lombok/ title="lombok 利器"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/code/2021-10-28-spring-security-overview/ title="Spring security 概觀"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>kubernetes - day22</h1><p class=mb-1>September 12, 2020</p><p>&mdash;</p></div><div class=content><p>接續上一章的實作，這邊將使用 NFS(Network File System) 分散式儲存系統實現永久儲存，它可以讓客戶端像是在本地端取得資料。</p><h2 id=nfs-儲存卷>NFS 儲存卷</h2><p>這邊將不使用 <code>GKE</code> 操作而是使用本地端架設的 <code>K8s</code> 來操作，將會有四台虛擬機，一台 <code>NFS</code>，其它則為 <code>K8s</code> 叢集。我們會在一台虛擬機上安裝 <code>NFS</code>，並設定要導出的儲存空間，之後再藉由設定檔方式去讓 <code>POD</code> 取得 <code>NFS</code> 的掛載目錄。在 <code>POD</code> 生命週期中，此方式只是會卸載掛載的資訊，並非像 <code>emptyDir</code> 一樣是直接刪除。其定義字段如下</p><ul><li>server: NFS Server 的 <code>IP</code> 或是能解析的域名</li><li>path: NFS Server 定義的共享檔案路徑</li><li>readOnly: 是否要唯讀，預設是 <code>false</code></li></ul><p>先在 <code>NFS</code> 的虛擬機上安裝 <code>NFS</code> 環境，在 NFS Server 主機安裝 <code>nfs-kernel-server</code>，客戶端安裝 <code>nfs-common</code>也就是 <code>K8s</code> 叢集的節點，安裝完之後在 NFS Server 設定以下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt install  -y
sudo mkdir /k8sData
echo <span style=color:#e6db74>&#34;/home/cch/k8sData *(rw,sync,no_root_squash)&#34;</span> | sudo tee /etc/exports <span style=color:#75715e># , 不能有空格隔開</span>
sudo exportfs -r <span style=color:#75715e># reload</span>
sudo showmount -e <span style=color:#75715e># 顯示 NFS 設定的要掛載目錄</span>
</code></pre></div><p><code>K8s</code> 的叢集節點進行 <code>NFS</code> 的掛載</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ mount NFS_SERVER_IP:/home/cch/k8sData /mnt
$ mount <span style=color:#75715e># 觀察有無掛載</span>
</code></pre></div><p>這是 <code>yaml</code> 的測試範例</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pod-nfs-demo</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ikubernetes/myapp:v1</span>
    <span style=color:#f92672>volumeMounts</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
      <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/usr/share/nginx/html/</span>
  <span style=color:#f92672>volumes</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
    <span style=color:#f92672>nfs</span>:
      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData</span>
      <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
</code></pre></div><p>接著在 NFS Server 上新增以下，上述完成 <code>K8s</code> 叢集上節點的 <code>/mnt</code> 下要有檔案</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ vi index.html <span style=color:#75715e># 要在 NFS Server 要掛載的目錄下新增</span>
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
</code></pre></div><p>將剛定義的 <code>yaml</code> 使用 <code>apply</code> 或其它方式進行布署，接著觀察布署後的 <code>POD</code>，並用 <code>curl</code> 驗證是否有讀取 NFS Server 的資料。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ kubectl get pods -o wide
NAME           READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES
pod-nfs-demo   1/1     Running   <span style=color:#ae81ff>0</span>          2m14s   10.244.2.32   node02   &lt;none&gt;           &lt;none&gt;
cch@master:~$ curl 10.244.2.32
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
cch@master:~$ curl 10.244.2.32
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
</code></pre></div><p>這邊在使用 <code>ReplicaSet</code> 實現多副本，用來實現不同節點上能夠有同步的資訊，也實現說不會因為被重新調度而讀取不到資料。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ReplicaSet</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>rs-nfs-demo</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>5</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
      <span style=color:#f92672>release</span>: <span style=color:#ae81ff>canary</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
        <span style=color:#f92672>release</span>: <span style=color:#ae81ff>canary</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ikubernetes/myapp:v1</span>
        <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/usr/share/nginx/html/</span>
      <span style=color:#f92672>volumes</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
          <span style=color:#f92672>nfs</span>:
            <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData</span>
            <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
</code></pre></div><p>同樣取得 <code>POD</code> 資訊，並用 <code>curl</code> 驗證</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ kubectl get pods -o wide -l app<span style=color:#f92672>=</span>myapp,release<span style=color:#f92672>=</span>canary
NAME                READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES
rs-nfs-demo-479qk   1/1     Running   <span style=color:#ae81ff>0</span>          95s   10.244.1.28   node01   &lt;none&gt;           &lt;none&gt;
rs-nfs-demo-8mk2z   1/1     Running   <span style=color:#ae81ff>0</span>          95s   10.244.2.35   node02   &lt;none&gt;           &lt;none&gt;
rs-nfs-demo-99z8w   1/1     Running   <span style=color:#ae81ff>0</span>          95s   10.244.1.26   node01   &lt;none&gt;           &lt;none&gt;
rs-nfs-demo-bkmbb   1/1     Running   <span style=color:#ae81ff>0</span>          95s   10.244.2.36   node02   &lt;none&gt;           &lt;none&gt;
rs-nfs-demo-hz4l9   1/1     Running   <span style=color:#ae81ff>0</span>          95s   10.244.1.27   node01   &lt;none&gt;           &lt;none&gt;
cch@master:~$ curl 10.244.1.28
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
cch@master:~$ curl 10.244.2.35
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
cch@master:~$ curl 10.244.1.26
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
cch@master:~$ curl 10.244.2.36
&lt;h1&gt;NFS Server <span style=color:#66d9ef>$(</span>hostname<span style=color:#66d9ef>)</span>&lt;/h1&gt;
</code></pre></div><p>透過上面的驗證可以說明，<code>NFS</code> 可以為 <code>POD</code> 達到持久性儲存，<code>POD</code> 被重新調度時也能夠有完整的資訊。要將其儲存刪除則是要以 <code>NFS</code> 管理員身分去做刪除，並非是 <code>POD</code>。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/kubernetes/2020-09-11-volume/ title="kubernetes - day21"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/kubernetes/2020-09-13-persistent-volume/ title="kubernetes - day23"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
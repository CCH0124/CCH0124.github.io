<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>kubernetes 網路溝通基礎</h1><p class=mb-1>December 12, 2021</p><p>&mdash;</p></div><div class=content><p>以 Kubernetes 角度來看，網路大致有四種通訊類型</p><ol><li>Container to Container
Pod 內的容器共享同一網路，通常由 <code>pause</code> 基礎架構容器提供。彼此間可透過 lo 接口交互。</li></ol><p><img src=https://miro.medium.com/max/1400/1*oyGbXt7kStLd85ZT4it3oQ.png alt>from 此篇<a href=https://medium.com/google-cloud/understanding-kubernetes-networking-pods-7117dd28727>文章</a></p><ol start=2><li><p>Pod to Pod
每個 Pod 擁有一個在集群中全域唯一的 IP 地址，可直接與其它 Pod 通訊。如上圖所示，其節點也可以透過同一網路的橋接設備(docker0)與 Pod 進行通訊。</p></li><li><p>Service to Pod
Service 資源也稱 <em>Cluster network</em>，啟動 <code>kube-apiserver</code> 時由 <code>--service-cluster-ip-range</code> 進行指定。當我們對 Service 資源進行變動時，會藉由 Api Server 觸發節點上的 <code>kube-proxy</code>，並設置相對應的 <code>iptables</code> 或 <code>ipvs</code> 規則，方便實現 Cluster-IP 與 Pod-IP 之間進行轉發。</p></li></ol><p>可參考此篇<a href=https://medium.com/google-cloud/understanding-kubernetes-networking-services-f0cb48e4cc82>文章</a></p><ol start=4><li>WAN to Pod
這須透過 nodePort、LoadBalancer 類型的 Service 資源實現。</li></ol><h2 id=pod-網路>Pod 網路</h2><p>在配置時，<code>kubelet</code> 會在預設的 <code>/etc/cni/net.d/</code> 目錄中搜尋 CNI 的 json 配置檔，並藉由 type 查找 <code>/opt/cni/bin</code> 下相關插件</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat 05-cilium.conf
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;cniVersion&#34;</span>: <span style=color:#e6db74>&#34;0.3.1&#34;</span>,
  <span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;cilium&#34;</span>,
  <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;cilium-cni&#34;</span>,
  <span style=color:#e6db74>&#34;enable-debug&#34;</span>: false
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>master in /opt/cni/bin
○ → ls
bandwidth  bridge  cilium-cni  dhcp  firewall  flannel  host-device  host-local  ipvlan  loopback  macvlan  portmap  ptp  sbr  static  tuning  vlan
</code></pre></div><p>CNI 僅是一個規範，其提供類型分為三類</p><ul><li>main<ul><li>實作特定網路功能，<code>loopback</code>、<code>bridge</code>、<code>ipvlan</code> 等</li></ul></li><li>meta<ul><li>本身不提供網路的實現，而是調用其他套件</li></ul></li><li>ipam<ul><li>僅分配 IP 地址。不提供其他網路實現</li></ul></li></ul></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/kubernetes/2021-10-23-rbac/ title="kubernetes 之訪問安全控制 - RBAC"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/kubernetes/2021-12-14-network-policy/ title="kubernetes network policy"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
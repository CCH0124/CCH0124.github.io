<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>kubernetes network policy</h1><p class=mb-1>December 12, 2021</p><p>&mdash;</p></div><div class=content><p><code>Network policy</code> 用於控制分組的 Pod 資源彼此之間如何進行通訊，獲分組的 Pod 資源如何與其它網路端點進行通訊的規範。它是一種更為精細的流量控制，實現租戶隔離機制。</p><p>Kubernetes 中，封包流入和流出的地點是 Pod 資源，所以 <code>NetworkPolicy</code> 資源也使用標籤選擇器選出一組 Pod 資源作為控管對象。內容會定義入的流量 <em>ingress 規則</em>，或是出的流量 <em>Egress 規則</em>。是否為部分或是全部生效取決於 <code>policyTypes</code>。</p><p><img src=https://img.uj5u.com/2021/01/05/212012050607101.png alt></p><p>在還沒進行 <code>Network policy</code> 資源綁定時，Pod 是可接受四面八方的流量，並做出回應。而當綁定 <code>Network policy</code> 資源後，可以將某些流量進行隔離。</p><ul><li>podSelector<ul><li>透過策略來選擇特定一群的 Pod，可藉由 <code>macthLabel</code> 或是 <code>matchExpression</code> 獲取</li></ul></li><li>Egress<ul><li>出站流量，通常由流量的網路端點(to)和 port 進行定義</li></ul></li><li>Ingress<ul><li>入站流量，通常由流量的網路端點(from)和流量目標 port 所定義</li></ul></li><li>端點 to 或 from<ul><li>其可以是 CIDR 格式的 IP 地址(ipBlock)<code>、namespaceSelector</code> 或是 <code>podSelector</code></li></ul></li></ul><p>在 <code>Egress</code> 或 <code>Ingress</code> 都可使用網路端點，其通常是某 namespace 中的一或一組 Pod 資源，會經由 <code>namespaceSelector</code> 選定特定 <code>namespace</code> 後，經由 <code>ipBlock</code> 或 <code>podSelector</code> 進行指定。在未定義 <code>Egress</code> 或 <code>Ingress</code> 默認是非隔離狀態。一旦在 <code>networkpolicy.spec</code> 中給出 <code>Ingress</code> 或 <code>Egress</code>，則它們的 <code>from</code> 或 <code>to</code> 字段的值就成了白名單列表，而空值意味著所有端點，即不限制訪問。</p><blockquote><p>NetworkPolicy 資源屬於 <code>namespace</code> 級別。</p></blockquote><h2 id=ingress-入站>Ingress 入站</h2><p><code>Ingress</code> 字段，主要有以下</p><ul><li><code>from</code><ul><li>白名單</li></ul></li><li><code>to</code><ul><li>白名單</li></ul></li></ul><p>當 from 和 to 同時定義表示 <code>and</code> 的邏輯關係，它將會放行滿足 from 和 to 的流量。</p><p><code>from</code> 可以使用以下，當定義了兩個以上，則會有 <code>or</code> 邏輯關係。</p><ul><li>ipBlock<ul><li>根據 IP 地址選擇流量來源端點</li></ul></li><li>namespaceSelector<ul><li>挑選 namespace</li><li>空值表示所有 namespace</li></ul></li><li>podSelector<ul><li>於 <code>NetworkPolicy</code> 所在的 namespace 內基於標籤選擇器挑選的 Pod 資源</li><li>空值表示所有 Pod 資源，在當前 namespace 下</li></ul></li><li>ports 透過以下兩個定義流量目標端口<ul><li>port</li><li>protocol</li></ul></li></ul><h2 id=egress-出站>Egress 出站</h2><p><code>Egress</code> 字段，主要有以下</p><ul><li>to<ul><li>當有給定限制時，只有目標地址匹配列表中主機地址的出站流量被放行</li></ul></li><li>ports<ul><li>目標端口列表</li></ul></li></ul><p>期內嵌的字段與 Ingress 是相同，區別是在於流量方向。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/kubernetes/2021-12-12-kubernetes-network/ title="kubernetes 網路溝通基礎"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><i class="nav-menu-disabled fas fa-chevron-circle-right"></i></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>
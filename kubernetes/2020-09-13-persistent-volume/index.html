<!doctype html><html lang=en-us style=max-width:1000px;margin:auto><head><title>Kevin Blog</title><meta name=theme-color content><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta name=description content="Kevin learning"><meta name=author content="Kevin Chen"><meta name=generator content="aafu theme by Darshan in Hugo 0.83.0"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.15.2/css/all.css integrity=sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu crossorigin=anonymous><link rel=stylesheet href=https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css><link rel=stylesheet href="//fonts.googleapis.com/css?family=Didact+Gothic%7CRoboto:400%7CRoboto+Mono"><link rel=stylesheet href=/css/aafu_pinkish.css><link rel=stylesheet href=/css/aafu.css><script>var themeColor=document.querySelector("meta[name=theme-color]");window.onload=()=>{themeColor.content=getComputedStyle(document.body)["background-color"];let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")},window.onresize=()=>{let a=document.querySelector(".accordion.active");a&&(a.nextElementSibling.style.maxHeight=a.nextElementSibling.scrollHeight+"px")}</script></head><body class=container><main style="min-height:calc(100vh - 60px)"><div class="d-flex flex-row row p-2"><h3 class="main-menu mr-3"><a href=https://cch0124.github.io/>Home</a></h3><h3 class="main-menu mr-3"><a href=/blog>Blog</a></h3><h3 class="main-menu mr-3"><a href=/project>Project</a></h3><h3 class="main-menu mr-3"><a href=/life>Life</a></h3><h3 class="main-menu mr-3"><a href=/kubernetes>Kubernetes</a></h3><h3 class="main-menu mr-3"><a href=/code>Coding</a></h3></div><div class=mb-3><h1 class=top-h1 style=font-size:2.75em>kubernetes - day23</h1><p class=mb-1>September 13, 2020</p><p>&mdash;</p></div><div class=content><p>PersistentVolume(PV)是由管理者提供並配置在某一個儲存方案的一個空間，它將儲存抽象成一個可讓使用者去申請的資源。以前面的 <code>NFS</code> 為例，我們都在 <code>POD</code> 中直接定義關於儲存的細節像是 <code>IP</code> 等，在這的做法缺少靈活性，當儲存要變換 <code>IP</code> 或是儲存的路徑，會相對的麻煩。因此可藉由 <code>PV</code> 變成是 <code>POD</code> 和儲存方案中間的抽象層，這使得 <code>POD</code> 不需要知道儲存的細節，這全部由 <code>PV</code> 去定義連接與使用，而 <code>PV</code> 使用需要透過 PersistentVolumeClaim(PVC) 描述的資源來完成綁定，也就是向 <code>PV</code> 申請儲存空間大小或是存取權限。其整體示意圖如下</p><figure><img src=/images/k8s/K8s-PV-PVC.jpg width=auto height=auto></figure><p>講完了 <code>PV</code> 和 <code>PVC</code> 概念後這邊來實作，環境是基於上一章。</p><h2 id=建立-pv-資源>建立 PV 資源</h2><p><code>PersistentVolume</code> 的定義有以下常見字段</p><ul><li>Capacity<ul><li><code>PV</code> 儲存空間大小定義</li></ul></li><li>AccessMode<ul><li>存取模式有以下值，詳細看<a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes>官方</a>當中會說明有儲存方案支援哪些模式<ul><li>ReadWriteOnce</li><li>ReadOnlyMany</li><li>ReadWriteMany</li></ul></li></ul></li><li>persistentVolumeReclaimPolicy<ul><li><code>PVC</code> 移除時對應的 <code>PV</code> 動作</li><li>Retain<ul><li>保存資料</li><li>預設值</li></ul></li><li>Delete<ul><li>對應的 <code>PV</code> 資源和資料一同刪除</li></ul></li><li>Recycle<ul><li>保留 <code>PV</code>，移除資料</li></ul></li></ul></li><li>volumeMode<ul><li>指定為 <code>Filesystem</code> 或是其它，預設為 <code>Filesystem</code></li></ul></li><li>storageClassName<ul><li><code>PV</code> 所屬的 <code>StorageClass</code> 的名稱，默認為空值表示不屬於任何</li></ul></li></ul><p>其字段還有很多可搭配，因為太多東西因此學起來會需要時間&mldr;。我們開始實驗吧!!</p><p>先在 NFS Server 上創建多個目錄，用於實驗 <code>PV</code> 與 <code>PVC</code>。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ mkdir pv<span style=color:#f92672>{</span>1,2,3,4,5<span style=color:#f92672>}</span> 
$ sudo vi /etc/exports
/home/cch/k8sData/pv1 *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>
/home/cch/k8sData/pv2 *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>                                                                          /home/cch/k8sData/pv3 *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>                                                                          /home/cch/k8sData/pv4 *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>                                                                          /home/cch/k8sData/pv5 *<span style=color:#f92672>(</span>rw,sync,no_root_squash<span style=color:#f92672>)</span>
$ sudo exportfs -avr
$ showmount -e
Export list <span style=color:#66d9ef>for</span> mars:
/home/cch/k8sData/pv5 *
/home/cch/k8sData/pv4 *
/home/cch/k8sData/pv3 *
/home/cch/k8sData/pv2 *
/home/cch/k8sData/pv1 *
</code></pre></div><p>建立 <code>PV</code> 的 <code>yaml</code>，<code>persistentVolumeReclaimPolicy</code> 則使用預設，下面不設定</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv001</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv001</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>nfs</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData/pv1</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteMany&#34;</span>, <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
  <span style=color:#75715e>#persistentVolumeReclaimPolicy: Recycle # persistentVolumeReclaimPolicy 屬性設定方式</span>
  <span style=color:#f92672>capacity</span>:
    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>2Gi</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv002</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv002</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>nfs</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData/pv2</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
  <span style=color:#f92672>capacity</span>:
    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>5Gi</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv003</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv003</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>nfs</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData/pv3</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteMany&#34;</span>, <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
  <span style=color:#f92672>capacity</span>:
    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>20Gi</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv004</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv004</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>nfs</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData/pv4</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteMany&#34;</span>, <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
  <span style=color:#f92672>capacity</span>:
    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv005</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pv005</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>nfs</span>:
    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/cch/k8sData/pv5</span>
    <span style=color:#f92672>server</span>: <span style=color:#ae81ff>192.168.134.130</span>
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteMany&#34;</span>, <span style=color:#e6db74>&#34;ReadWriteOnce&#34;</span>]
  <span style=color:#f92672>capacity</span>:
    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>10Gi</span>
</code></pre></div><p>查看建立的 <code>PV</code> 狀態，<code>RECLAIM POLICY</code> 就是 <code>persistentVolumeReclaimPolicy</code> 的設定。<code>STATUS</code> 有以下的可能</p><ul><li>Available<ul><li>表示 <code>PV</code> 為可用狀態，但尚未被 <code>PVC</code> 綁定</li></ul></li><li>Bound<ul><li>表示已綁定到 <code>PVC</code></li></ul></li><li>Released<ul><li><code>PVC</code> 已被刪除，但是資源尚未回收</li></ul></li><li>Failed<ul><li>回收失敗</li></ul></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cch@master:~$ kubectl get pv -o wide
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE   VOLUMEMODE
pv001   2Gi        RWO,RWX        Retain           Available                                   63s   Filesystem
pv002   5Gi        RWO            Retain           Available                                   63s   Filesystem
pv003   20Gi       RWO,RWX        Retain           Available                                   63s   Filesystem
pv004   10Gi       RWO,RWX        Retain           Available                                   63s   Filesystem
pv005   10Gi       RWO,RWX        Retain           Available                                   63s   Filesystem
</code></pre></div><p><code>PV</code> 建立好之後接著要談 <code>PVC</code>，上面實驗結果先保留之後 <code>PVC</code> 要接續請求 <code>PV</code>。</p><h2 id=建立-pvc-資源>建立 PVC 資源</h2><p>簡單來說就是用來請求一個 <code>PV</code> 所建立的，是一個一對一的模式。對 <code>PV</code> 做請求時只需要定義要的空間、存取模式、標籤選擇器等訊息即可，系統會自動匹配一個，就像 <code>POD</code> 被布署在節點上一樣。下面是一個 <code>PVC</code> 請求 <code>PV</code> 和 <code>POD</code> 請求 <code>PVC</code> 的 <code>yaml</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>mypvc</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>accessModes</span>: [<span style=color:#e6db74>&#34;ReadWriteMany&#34;</span>] <span style=color:#75715e># 用來匹配 PV</span>
  <span style=color:#f92672>resources</span>: <span style=color:#75715e># 用來匹配 PV</span>
    <span style=color:#f92672>requests</span>:
      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>6Gi</span> <span style=color:#75715e># 需要大於等於</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>pod-vol-pvc</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>containers</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>myapp</span>
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ikubernetes/myapp:v1</span>
    <span style=color:#f92672>volumeMounts</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
      <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/usr/share/nginx/html/</span>
  <span style=color:#f92672>volumes</span>: <span style=color:#75715e># 定義儲存卷</span>
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>html</span>
    <span style=color:#f92672>persistentVolumeClaim</span>: <span style=color:#75715e># 使用 PVC</span>
      <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>mypvc</span> <span style=color:#75715e># 使用的 PVC 名稱</span>
</code></pre></div><p>布署上面 <code>yaml</code>，並使用 <code>get pv</code> 查看是否有 <code>PV</code> 被綁定。下面結果是 <code>pv004</code> 的 <code>PV</code>。使用 <code>get pvc</code> 也可以查看 <code>pvc</code> 被綁定到哪個 <code>PV</code>，並有一些相關訊息。但是 <code>PVC</code> 請求到的 <code>PV</code> 可能會是有浪費空間的情況，因為 <code>PVC</code> 是請求一個符合定義條件的 <code>PV</code>，但有可能 <code>PV</code> 定義的資源並非那麼的剛好，<code>PVC</code> 要 10G 的空間，但 <code>PV</code> 只有一個 15G 的可用符合條件，選擇了此 <code>PV</code> 後將會浪費 5G 的空間。在 <code>PV</code> 的資源定義中可在 <code>spec</code> 下定義 <code>claimRef</code> 指定該 <code>PV</code> 要被哪個 <code>PVC</code> 使用。</p><p>下面 <code>NAME</code> 為 pv004 的 <code>CLAIM</code> 表示說被 default 的 namespace 中 mypvc 的 <code>PVC</code> 綁定。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ kubectl apply -f pod-pvc-demo.yaml
persistentvolumeclaim/mypvc unchanged
pod/pod-vol-pvc created
$ kubectl get pv -o wide
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON   AGE   VOLUMEMODE
pv001   2Gi        RWO,RWX        Retain           Available                                           12m   Filesystem
pv002   5Gi        RWO            Retain           Available                                           12m   Filesystem
pv003   20Gi       RWO,RWX        Retain           Available                                           12m   Filesystem
pv004   10Gi       RWO,RWX        Retain           Bound       default/mypvc                           12m   Filesystem
pv005   10Gi       RWO,RWX        Retain           Available                                           12m   Filesystem
$ kubectl get pvc -o wide
NAME    STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE     VOLUMEMODE
mypvc   Bound    pv004    10Gi       RWO,RWX                       4m27s   Filesystem
</code></pre></div><p>上面的實驗過程布署從 <code>PV</code> 到 <code>PVC</code> 到 <code>POD</code>，假設是從 <code>POD</code> 開始布署則會出現 <code>Pending</code> 是因為 <code>PVC</code> 沒有找到 <code>PV</code>，當然只要 <code>PV</code> 沒布署 <code>PVC</code> 也會是 <code>Pending</code> 狀態，這邊感覺是儲存的需求要先被定義，才能布署 <code>POD</code>，這有點矛盾而 <code>Storage class</code> 將會改善這些綁定的缺點。</p><blockquote><p>PVC 具有 namespace，PV 綁定 PVC 可不受限制，但 PVC 和 POD 要在同一個 namespace 下</p></blockquote><h2 id=結論>結論</h2><p>相較於先前用 <code>volumes</code> 方式，使用 <code>PV</code> 和 <code>PVC</code> 讓整個資源變得更複雜一點，多定義了 <code>PV</code> 和 <code>PVC</code> 資源，這同時也提升除錯難易度。下一個章節會講到 <code>Storage class</code>，它為會儲存帶來更好的管理方式。</p></div><div class="d-flex flex-row justify-content-around"><h3 class="mb-1 mt-1 text-left mr-4"><a href=/kubernetes/2020-09-12-volume-nfs/ title="kubernetes - day22"><i class="nav-menu fas fa-chevron-circle-left"></i></a></h3><h3 class="mb-1 mt-1 text-left ml-4"><a href=/kubernetes/2020-09-14-volume-storage-class/ title="kubernetes - day24"><i class="nav-menu fas fa-chevron-circle-right"></i></a></h3></div></main><footer class="mt-2 mb-4 text-center"><span class=markdownify>short copyright message</span>
<span>&#183;
<i><a href=https://github.com/darshanbaral/aafu>aafu</a></i>
by
<a href=https://www.darshanbaral.com/>darshan</a></span></footer></body></html>